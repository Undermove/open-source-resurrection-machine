<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Team Health Check (Spotify model) ‚Äî CSV export</title>
  <style>
    :root{
      --bg0:#f6f7fb;
      --bg1:#ffffff;
      --panel:#ffffff;
      --stroke:rgba(15, 23, 42, .10);
      --stroke2:rgba(15, 23, 42, .08);
      --text:#0f172a;
      --muted:rgba(15, 23, 42, .62);
      --accent:#2563eb;
      --ok:#16a34a;
      --warn:#f59e0b;
      --bad:#ef4444;
      --shadow: 0 14px 45px rgba(2, 6, 23, .10);
      --shadow2: 0 10px 24px rgba(2, 6, 23, .08);
      --chip: rgba(15, 23, 42, .05);
      --chip2: rgba(15, 23, 42, .08);
      --radius: 14px;
      --glass: rgba(255,255,255,.58);
      --glass2: rgba(255,255,255,.72);
    }

    .sumCell{
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 10px;
      min-height: 34px;
    }
    .sumDot{
      width: 14px;
      height: 14px;
      border-radius: 999px;
      box-shadow: 0 10px 18px rgba(2, 6, 23, .10);
      border: 2px solid color-mix(in srgb, var(--glass2) 70%, transparent);
    }
    .sumDot.ok{ background: var(--ok); }
    .sumDot.warn{ background: var(--warn); }
    .sumDot.bad{ background: var(--bad); }
    .sumTrend{
      font-weight: 900;
      font-size: 14px;
      letter-spacing: .2px;
    }

    .smPad{ padding: 8px 10px; }
    .smPadTight{ padding: 6px 10px; }

    #multiTable{
      border-spacing: 4px;
      table-layout: fixed;
    }
    #multiTable tbody tr{ height: auto; }

    .multiWrapHidden{ display:none; }

    .dropzone{
      border-radius: var(--radius);
      border: 2px dashed color-mix(in srgb, var(--accent) 28%, var(--stroke));
      background: color-mix(in srgb, var(--glass) 82%, transparent);
      box-shadow: 0 14px 30px rgba(2, 6, 23, .10);
      backdrop-filter: blur(14px);
      padding: 22px 18px;
      min-height: 120px;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      color: color-mix(in srgb, var(--text) 90%, transparent);
    }
    .dropzone strong{ display:block; font-size: 14px; margin-bottom: 6px; }
    .dropzone .muted{ color: var(--muted); font-size: 12px; line-height: 1.35; }
    .dropzone.dragover{
      border-color: color-mix(in srgb, var(--accent) 55%, var(--stroke));
      box-shadow: 0 18px 40px rgba(2, 6, 23, .14);
    }

    .multiFileInput{
      position:absolute;
      width:1px;
      height:1px;
      padding:0;
      margin:-1px;
      overflow:hidden;
      clip:rect(0,0,0,0);
      white-space:nowrap;
      border:0;
    }

    /* Multi table: equal column widths and equal row heights */
    #multiTable th,
    #multiTable td{ width: 150px; min-width: 150px; max-width: 150px; }
    #multiTable thead th,
    #multiTable tbody th,
    #multiTable tbody td{ vertical-align: middle; }
    #multiTable tbody tr{ height: 44px; }
    #multiTable .glassPad{ padding: 6px 10px; }
    html, body{
      margin:0;
      min-height:100%;
      background: radial-gradient(circle at 50% 20%, var(--bg1) 0%, var(--bg0) 60%);
      color:var(--text);
      font-family:-apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Inter, Arial, sans-serif;
    }

    @media (prefers-color-scheme: dark){
      :root{
        --bg0:#07070b;
        --bg1:#0d0d16;
        --panel:rgba(0,0,0,.22);
        --stroke:rgba(255,255,255,.12);
        --stroke2:rgba(255,255,255,.08);
        --text:#e9e9f3;
        --muted:rgba(233,233,243,.72);
        --accent:#7cd1ff;
        --ok:#7aff8f;
        --warn:#ffcf5b;
        --bad:#ff6b6b;
        --shadow: 0 14px 45px rgba(0,0,0,.55);
        --shadow2: 0 10px 24px rgba(0,0,0,.45);
        --chip: rgba(255,255,255,.06);
        --chip2: rgba(255,255,255,.10);
        --glass: rgba(10,10,16,.46);
        --glass2: rgba(10,10,16,.58);
      }
    }

    a{ color: inherit; text-decoration: underline; }
    a:focus-visible{ outline:2px dashed var(--accent); outline-offset: 3px; }

    .skip{
      position:absolute;
      top:0;
      left:0;
      transform: translateY(-120%);
      padding:10px 12px;
      background: rgba(0,0,0,.75);
      border: 1px solid var(--stroke);
      border-radius: 0 0 10px 0;
      color: var(--text);
      z-index: 50;
    }
    .skip:focus{ transform: translateY(0); }

    header{
      padding: 18px clamp(14px, 4vw, 28px);
      border-bottom: 1px solid var(--stroke2);
      background: color-mix(in srgb, var(--panel) 86%, transparent);
      position: sticky;
      top: 0;
      backdrop-filter: blur(10px);
      z-index: 10;
    }
    header .row{
      display:flex;
      gap: 12px;
      align-items: baseline;
      justify-content: space-between;
      flex-wrap: wrap;
      max-width: 1100px;
      margin: 0 auto;
    }
    header h1{
      margin:0;
      font-size: clamp(18px, 2.4vw, 24px);
      letter-spacing: .2px;
    }
    header p{
      margin: 6px 0 0;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.45;
      max-width: 74ch;
    }

    main{ padding: 18px clamp(14px, 4vw, 28px) 34px; }
    .wrap{
      max-width: 1100px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 1fr;
      gap: 14px;
    }

    .toolbar{
      display:flex;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
    }
    .toolbar .left{
      display:flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    .toolbar .hint{
      color: var(--muted);
      font-size: 12px;
      line-height: 1.4;
      max-width: 72ch;
    }

    .panel{
      background: var(--panel);
      border: none;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      overflow:hidden;
    }
    .panel .hd{
      padding: 12px 14px;
      border-bottom: none;
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
    }
    .panel .hd h2{
      margin:0;
      font-size: 14px;
      letter-spacing: .2px;
    }
    .panel .bd{ padding: 14px; }

    label{ display:block; font-size: 12px; color: var(--muted); margin-bottom: 6px; }
    input[type="text"], input[type="date"], textarea{
      width: 100%;
      box-sizing: border-box;
      border-radius: 12px;
      border: none;
      background: color-mix(in srgb, var(--glass2) 86%, transparent);
      color: var(--text);
      padding: 10px 12px;
      font: inherit;
      outline: none;
      box-shadow: 0 10px 24px rgba(2, 6, 23, .06);
    }
    textarea{ min-height: 92px; resize: vertical; }
    input[type="text"]:focus-visible, input[type="date"]:focus-visible, textarea:focus-visible{
      outline: 2px dashed var(--accent);
      outline-offset: 2px;
    }

    .matrixWrap{
      overflow:auto;
      border-radius: var(--radius);
      border: none;
      background: transparent;
      box-shadow: none;
    }
    table.matrix{
      width: max-content;
      border-collapse: separate;
      border-spacing: 6px;
      table-layout: fixed;
    }
    table.matrix th, table.matrix td{
      border-right: none;
      border-bottom: none;
      vertical-align: top;
      padding: 0;
      background: transparent;
    }
    table.matrix thead th{
      position: sticky;
      top: 0;
      z-index: 2;
      background: transparent;
      backdrop-filter: blur(10px);
    }
    table.matrix th:first-child,
    table.matrix td:first-child{
      position: sticky;
      left: 0;
      z-index: 1;
      background: transparent;
      backdrop-filter: blur(10px);
      width: 300px;
      min-width: 300px;
      max-width: 300px;
    }
    table.matrix thead th:first-child{
      z-index: 3;
    }

    .glassCard{
      background: color-mix(in srgb, var(--glass) 92%, transparent);
      border-radius: var(--radius);
      box-shadow: 0 12px 28px rgba(2, 6, 23, .10);
      backdrop-filter: blur(14px);
      overflow:hidden;
    }
    .glassCard:hover{
      box-shadow: 0 16px 36px rgba(2, 6, 23, .14);
    }
    .glassPad{ padding: 12px; }

    .indicatorCard{
      display:grid;
      grid-template-columns: 54px 1fr;
      gap: 10px;
      align-items: start;
    }

    .indicatorFixed{
      width: 300px;
      height: 360px;
      min-height: 360px;
      max-height: 360px;
    }

    .indicatorFixed .glassPad{
      height: 360px;
      box-sizing: border-box;
      overflow: hidden;
      padding: 0;
    }

    .indicatorFixed .glassPad.indicatorCard{
      height: 100%;
    }

    .indicatorFixed .indicatorCard{
      height: 100%;
      align-items: stretch;
    }

    .indicatorFixed .indicatorCard > div:last-child{
      min-width: 0;
      min-height: 0;
    }

    .indicatorFixed .indicatorTitleV{
      display:flex;
      align-items:center;
      justify-content:center;
      height: 100%;
      align-self: stretch;
      border-radius: 0;
      border-top-left-radius: var(--radius);
      border-bottom-left-radius: var(--radius);
      box-shadow: none;
    }

    .indicatorText{
      width: 100%;
      height: 100%;
      min-width: 0;
      min-height: 0;
      display:flex;
      flex-direction: column;
      align-items: flex-start;
      text-align: left;
      gap: 8px;
      justify-content: center;
      overflow: auto;
      padding: 12px 28px 12px 12px;
      box-sizing: border-box;
      overflow-wrap: anywhere;
      word-break: break-word;
    }

    .indicatorText .indTitle,
    .indicatorText .indMeta{
      white-space: normal;
      overflow-wrap: anywhere;
      word-break: break-word;
      hyphens: auto;
    }

    .indicatorText::-webkit-scrollbar{ width: 8px; }
    .indicatorText::-webkit-scrollbar-thumb{ background: rgba(0,0,0,.18); border-radius: 999px; }
    @media (prefers-color-scheme: dark){
      .indicatorText::-webkit-scrollbar-thumb{ background: rgba(255,255,255,.18); }
    }

    table.matrix tbody tr{ height: 360px; }

    .cellFixed{
      height: 360px;
    }

    .cellFixed .glassPad{
      height: 360px;
      box-sizing: border-box;
    }

    .cellFixed .cell{
      height: 100%;
      align-content: center;
      justify-items: center;
    }

    .cellFixed .cell > *{
      width: 100%;
    }
    .indicatorTitleV{
      writing-mode: vertical-rl;
      text-orientation: mixed;
      font-weight: 900;
      letter-spacing: .4px;
      font-size: 12px;
      color: color-mix(in srgb, var(--text) 90%, transparent);
      padding: 0;
      border-radius: 12px;
      background: color-mix(in srgb, var(--accent) 10%, var(--glass2));
      box-shadow: 0 10px 18px rgba(2, 6, 23, .08);
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .indTitle{ font-weight: 900; font-size: 13px; margin: 0; line-height: 1.25; }
    .indMeta{ color: var(--muted); font-size: 12px; line-height: 1.45; margin-top: 0; }
    .indMeta .k{ font-weight: 800; color: color-mix(in srgb, var(--text) 86%, transparent); }

    .colHead{
      display:flex;
      flex-direction: column;
      gap: 8px;
      min-width: 140px;
    }
    .colRow{
      display:flex;
      gap: 8px;
      align-items: center;
      justify-content: space-between;
    }
    .colRow .colTitle{ font-weight: 850; font-size: 13px; }
    .colRow .colActions{ display:flex; gap: 8px; }
    .iconBtn{
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      color: var(--text);
      font: inherit;
      font-weight: 750;
      cursor: pointer;
      line-height: 1;
      white-space: nowrap;
    }
    .iconBtn:hover{ background: rgba(255,255,255,.10); }
    .iconBtn:active{ transform: translateY(1px); }
    .iconBtn:focus-visible{ outline:2px dashed var(--accent); outline-offset: 2px; }

    .plusBtn{
      width: 44px;
      height: 44px;
      border-radius: 999px;
      border: none;
      background: color-mix(in srgb, var(--glass2) 78%, transparent);
      color: var(--text);
      cursor: pointer;
      font: inherit;
      font-weight: 900;
      line-height: 1;
      box-shadow: 0 12px 24px rgba(2, 6, 23, .10);
    }
    .plusBtn:hover{ box-shadow: 0 16px 32px rgba(2, 6, 23, .14); }
    .plusBtn:active{ transform: translateY(1px); }
    .plusBtn:focus-visible{ outline:2px dashed var(--accent); outline-offset: 2px; }

    .colFields{
      display:grid;
      grid-template-columns: 1fr;
      gap: 8px;
    }

    .participantCard .glassPad{ padding: 10px; }
    .colFields input[type="text"],
    .colFields input[type="date"]{
      padding: 8px 10px;
      border-radius: 12px;
      font-size: 12px;
    }

    .cell{
      display:grid;
      grid-template-columns: 1fr;
      gap: 8px;
      min-width: 140px;
    }

    /* Participant columns: keep narrow and don't stretch across the whole viewport */
    table.matrix thead th:not(:first-child){
      width: 160px;
      min-width: 160px;
      max-width: 160px;
    }
    table.matrix thead th:last-child{ /* plus column */
      width: 84px;
      min-width: 84px;
      max-width: 84px;
    }

    table.matrix tbody td{ width: 160px; min-width: 160px; max-width: 160px; }
    table.matrix tbody td:last-child{ width: 84px; min-width: 84px; max-width: 84px; }

    /* Let table be content-width, not stretched */
    #matrixHead, #matrixBody{ width: auto; }
    .statusDots{
      display:flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
      justify-content: center;
    }
    .statusDots input{ position:absolute; opacity:0; pointer-events:none; }
    .dotLbl{
      width: 28px;
      height: 28px;
      border-radius: 999px;
      border: none;
      background: color-mix(in srgb, var(--glass2) 82%, transparent);
      cursor: pointer;
      display:inline-flex;
      align-items: center;
      justify-content: center;
      user-select:none;
      box-shadow: 0 10px 18px rgba(2, 6, 23, .08);
    }
    .dotLbl:focus-visible{ outline:2px dashed var(--accent); outline-offset: 2px; }
    .dot{
      width: 10px;
      height: 10px;
      border-radius: 999px;
      display:inline-block;
    }
    .dot.ok{ background: var(--ok); }
    .dot.warn{ background: var(--warn); }
    .dot.bad{ background: var(--bad); }
    .statusDots input:checked + .dotLbl{
      border-color: color-mix(in srgb, var(--accent) 55%, var(--stroke));
      box-shadow: 0 0 0 3px color-mix(in srgb, var(--accent) 20%, transparent);
      background: color-mix(in srgb, var(--accent) 10%, var(--panel));
    }

    .trendSel{
      display:flex;
      align-items:center;
      gap: 8px;
    }
    select{
      width: 100%;
      box-sizing: border-box;
      border-radius: 12px;
      border: none;
      background: color-mix(in srgb, var(--glass2) 82%, transparent);
      color: var(--text);
      padding: 8px 10px;
      font: inherit;
      font-size: 12px;
      outline: none;
      box-shadow: 0 10px 18px rgba(2, 6, 23, .08);
    }
    select:focus-visible{ outline: 2px dashed var(--accent); outline-offset: 2px; }

    .trendHidden{
      display:none;
    }
    .noteHidden{
      display:none;
    }
    .trendHint{
      color: var(--muted);
      font-size: 12px;
      line-height: 1.25;
      padding: 8px 10px;
      border-radius: 12px;
      background: color-mix(in srgb, var(--glass2) 70%, transparent);
      box-shadow: 0 10px 18px rgba(2, 6, 23, .06);
    }

    .cell details{
      border: none;
      border-radius: 12px;
      background: color-mix(in srgb, var(--glass2) 72%, transparent);
      overflow:hidden;
      box-shadow: 0 10px 18px rgba(2, 6, 23, .06);
    }
    .cell details summary{
      cursor: pointer;
      padding: 10px 12px;
      font-size: 12px;
      color: color-mix(in srgb, var(--text) 88%, transparent);
      user-select: none;
      background: var(--chip);
    }
    .cell details summary:focus-visible{ outline:2px dashed var(--accent); outline-offset: 2px; }
    .cell details .noteBody{ padding: 10px 12px 12px; }
    .cell details textarea{ min-height: 72px; font-size: 12px; }

    details.notesDetails{
      border: none;
      border-radius: 12px;
      background: color-mix(in srgb, var(--glass2) 72%, transparent);
      overflow:hidden;
      box-shadow: 0 10px 18px rgba(2, 6, 23, .06);
    }
    details.notesDetails summary{
      cursor: pointer;
      padding: 10px 12px;
      font-size: 12px;
      color: color-mix(in srgb, var(--text) 88%, transparent);
      user-select: none;
      background: var(--chip);
    }
    details.notesDetails summary:focus-visible{ outline:2px dashed var(--accent); outline-offset: 2px; }
    details.notesDetails .noteBody{ padding: 10px 12px; }
    details.notesDetails .noteBody textarea{ min-height: 90px; }

    .metaGrid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }
    @media (min-width: 860px){
      .metaGrid{ grid-template-columns: 2fr 1fr 2fr; }
      .metaGrid .span3{ grid-column: 1 / -1; }
    }

    .btnrow{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      justify-content: flex-end;
    }

    .tabbar{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      justify-content: flex-start;
      margin-bottom: 14px;
    }
    .tabbtn{
      border-radius: 999px;
      padding: 8px 12px;
      border: none;
      background: color-mix(in srgb, var(--glass2) 70%, transparent);
      color: var(--text);
      cursor:pointer;
      font: inherit;
      font-weight: 850;
      box-shadow: 0 12px 24px rgba(2, 6, 23, .10);
    }
    .tabbtn[aria-selected="true"]{
      background: color-mix(in srgb, var(--accent) 16%, var(--glass2));
      box-shadow: 0 16px 32px rgba(2, 6, 23, .14);
    }
    .tabbtn:focus-visible{ outline: 2px dashed var(--accent); outline-offset: 2px; }

    .fileRow{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }
    input[type="file"]{
      width: 100%;
      box-sizing: border-box;
      border-radius: 12px;
      border: none;
      background: color-mix(in srgb, var(--glass2) 86%, transparent);
      color: var(--text);
      padding: 10px 12px;
      font: inherit;
      outline: none;
      box-shadow: 0 10px 24px rgba(2, 6, 23, .06);
    }
    input[type="file"]:focus-visible{ outline: 2px dashed var(--accent); outline-offset: 2px; }

    button{
      border-radius: 12px;
      padding: 10px 12px;
      border: none;
      background: color-mix(in srgb, var(--glass2) 78%, transparent);
      color: var(--text);
      cursor:pointer;
      font: inherit;
      font-weight: 700;
      box-shadow: 0 12px 24px rgba(2, 6, 23, .10);
    }
    button:hover{ background: rgba(255,255,255,.10); }
    button:active{ transform: translateY(1px); }
    button:focus-visible{ outline: 2px dashed var(--accent); outline-offset: 2px; }

    .status{
      display:flex;
      align-items:center;
      gap: 10px;
      flex-wrap: wrap;
      color: var(--muted);
      font-size: 12px;
    }

    .sr{
      position:absolute;
      width:1px;
      height:1px;
      padding:0;
      margin:-1px;
      overflow:hidden;
      clip: rect(0,0,0,0);
      white-space:nowrap;
      border:0;
    }

    footer{
      padding: 14px clamp(14px, 4vw, 28px) 24px;
      color: rgba(233,233,243,.68);
      font-size: 12px;
      line-height: 1.5;
      border-top: 1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.10);
    }
    footer .wrap{ max-width: 1100px; margin: 0 auto; }

    @media (prefers-reduced-motion: reduce){
      *{ scroll-behavior: auto; }
    }
  </style>
</head>
<body>
  <a class="skip" href="#main">–ü–µ—Ä–µ–π—Ç–∏ –∫ —Å–æ–¥–µ—Ä–∂–∏–º–æ–º—É</a>

  <header>
    <div class="row">
      <div>
        <h1>Team Health Check (Spotify Squad Health Check)</h1>
        <p>–ó–∞–ø–æ–ª–Ω–∏ –æ—Ü–µ–Ω–∫–∏ –ø–æ 10 –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞–º (–∑–µ–ª—ë–Ω—ã–π/–∂—ë–ª—Ç—ã–π/–∫—Ä–∞—Å–Ω—ã–π) –∏ —Ç—Ä–µ–Ω–¥ (—É–ª—É—á—à–∞–µ—Ç—Å—è/—Å—Ç–∞–±–∏–ª—å–Ω–æ/—É—Ö—É–¥—à–∞–µ—Ç—Å—è). –ó–∞—Ç–µ–º –≤—ã–≥—Ä—É–∑–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ CSV.</p>
      </div>
      <nav aria-label="–ù–∞–≤–∏–≥–∞—Ü–∏—è">
        <a href="index.html">–ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
      </nav>
    </div>
  </header>

  <main id="main">
    <div class="wrap">
      <div class="tabbar" role="tablist" aria-label="–†–∞–∑–¥–µ–ª—ã">
        <button class="tabbtn" id="tabMatrix" type="button" role="tab" aria-selected="true" aria-controls="matrixPanel">–ß–µ–∫-–ª–∏—Å—Ç</button>
        <button class="tabbtn" id="tabMulti" type="button" role="tab" aria-selected="false" aria-controls="multiPanel">–°–≤–æ–¥–∫–∞ –ø–æ —Ñ–∞–π–ª–∞–º</button>
      </div>

      <section class="panel" aria-label="–ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ" id="sessionPanel">
        <div class="hd">
          <h2>–°–µ—Å—Å–∏—è</h2>
          <div class="status">
            <div id="autosaveStatus" aria-live="polite"></div>
            <div class="btnrow">
              <button id="btnExport" type="button">–°–∫–∞—á–∞—Ç—å CSV</button>
              <button id="btnReset" type="button">–°–±—Ä–æ—Å–∏—Ç—å</button>
            </div>
          </div>
        </div>
        <div class="bd">
          <div class="metaGrid">
            <div>
              <label for="teamName">–ö–æ–º–∞–Ω–¥–∞ / Squad</label>
              <input id="teamName" name="teamName" type="text" autocomplete="organization" />
            </div>
            <div>
              <label for="checkDate">–î–∞—Ç–∞</label>
              <input id="checkDate" name="checkDate" type="date" />
            </div>
            <div>
              <label for="facilitator">–§–∞—Å–∏–ª–∏—Ç–∞—Ç–æ—Ä / –ê–≤—Ç–æ—Ä</label>
              <input id="facilitator" name="facilitator" type="text" autocomplete="name" />
            </div>
            <div class="span3">
              <details class="notesDetails">
                <summary>–û–±—â–∏–µ –∑–∞–º–µ—Ç–∫–∏ (–¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞)</summary>
                <div class="noteBody">
                  <label class="sr" for="globalNotes">–û–±—â–∏–µ –∑–∞–º–µ—Ç–∫–∏ (–¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞)</label>
                  <textarea id="globalNotes" name="globalNotes"></textarea>
                </div>
              </details>
            </div>
          </div>

        </div>
      </section>

      <section class="panel" aria-label="–°–≤–æ–¥–∫–∞ –ø–æ –Ω–µ—Å–∫–æ–ª—å–∫–∏–º –∫–æ–º–∞–Ω–¥–∞–º" id="multiPanel" style="display:none;">
        <div class="hd">
          <div class="toolbar">
            <div class="left">
              <h2 class="sr">–°–≤–æ–¥–∫–∞ –ø–æ –Ω–µ—Å–∫–æ–ª—å–∫–∏–º –∫–æ–º–∞–Ω–¥–∞–º</h2>
            </div>
            <div class="btnrow" id="multiActions" style="display:none;">
              <button id="btnClearMulti" type="button">–û—á–∏—Å—Ç–∏—Ç—å</button>
              <button id="btnExportMulti" type="button">–°–∫–∞—á–∞—Ç—å CSV (—Å–≤–æ–¥–∫–∞)</button>
            </div>
          </div>
        </div>
        <div class="bd">
          <input id="multiFiles" class="multiFileInput" type="file" accept=".csv,text/csv" multiple />

          <label id="multiDrop" class="dropzone" for="multiFiles">
            <div>
              <strong>–ü–µ—Ä–µ—Ç–∞—â–∏ CSV-—Ñ–∞–π–ª—ã —Å—é–¥–∞</strong>
              <div class="muted">–∏–ª–∏ –Ω–∞–∂–º–∏, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ñ–∞–π–ª–æ–≤ —Ö–µ–ª—Å—á–µ–∫–æ–≤ –∫–æ–º–∞–Ω–¥</div>
            </div>
          </label>

          <div id="multiTableWrap" class="matrixWrap multiWrapHidden" role="region" aria-label="–°–≤–æ–¥–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –ø–æ —Ñ–∞–π–ª–∞–º" tabindex="0">
            <table class="matrix" id="multiTable">
              <thead id="multiHead"></thead>
              <tbody id="multiBody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <section class="panel" aria-label="–ú–∞—Ç—Ä–∏—Ü–∞ Health Check" id="matrixPanel">
        <div class="hd">
          <div class="toolbar">
            <div class="left">
              <h2 style="margin:0;">Squad Health Checklist</h2>
            </div>
          </div>
        </div>
        <div class="bd">
          <div class="matrixWrap" role="region" aria-label="–ú–∞—Ç—Ä–∏—Ü–∞ Team Health Check" tabindex="0">
            <table class="matrix" id="matrix">
              <thead id="matrixHead"></thead>
              <tbody id="matrixBody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <section class="panel" aria-label="–§–æ—Ä–º–∞—Ç CSV">
        <div class="hd">
          <h2>–ß—Ç–æ –ø–æ–ø–∞–¥—ë—Ç –≤ CSV</h2>
        </div>
        <div class="bd">
          <p style="margin:0; color: var(--muted); font-size: 12px; line-height: 1.6;">–ö–∞–∂–¥–∞—è —Å—Ç—Ä–æ–∫–∞ CSV ‚Äî —ç—Ç–æ –æ–¥–∏–Ω –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –æ–¥–Ω–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞. –ü–æ–ª—è: <span style="color: rgba(233,233,243,.9);">participant_id, participant_name, team, date, facilitator, indicator, status, trend, note, overall_notes</span>.</p>
          <p style="margin:10px 0 0; color: var(--muted); font-size: 12px; line-height: 1.6;">–ú–æ–¥–µ–ª—å –≤–∑—è—Ç–∞ –∏–∑ —Å—Ç–∞—Ç—å–∏ Spotify Engineering: <a href="https://engineering.atspotify.com/2014/09/squad-health-check-model" target="_blank" rel="noopener noreferrer">Squad Health Check model</a>.</p>
        </div>
      </section>
    </div>
  </main>

  <footer>
    <div class="wrap">
      <div>–ü–æ–¥—Å–∫–∞–∑–∫–∞: –æ–±—ã—á–Ω–æ Health Check –ø—Ä–æ–≤–æ–¥—è—Ç –∫–∞–∫ –≤–æ—Ä–∫—à–æ–ø –∏ –ø—ã—Ç–∞—é—Ç—Å—è –ø—Ä–∏–π—Ç–∏ –∫ –∫–æ–Ω—Å–µ–Ω—Å—É—Å—É. –ó–¥–µ—Å—å —Ñ–æ—Ä–º–∞ ‚Äî –¥–ª—è —Ñ–∏–∫—Å–∞—Ü–∏–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –∏ –≤—ã–≥—Ä—É–∑–∫–∏.</div>
    </div>
  </footer>

  <script>
    (() => {
      const STORAGE_KEY = 'teamHealthCheck_matrix_v1';
      const LEGACY_STORAGE_KEY = 'teamHealthCheck_v1';

      const indicators = [
        {
          id: 'easy_to_release',
          title: '–õ—ë–≥–∫–æ—Å—Ç—å —Ä–µ–ª–∏–∑–∞',
          short: '–†–µ–ª–∏–∑',
          awesome: '–†–µ–ª–∏–∑–∏—Ç—å –ø—Ä–æ—Å—Ç–æ, –±–µ–∑–æ–ø–∞—Å–Ω–æ, –±–µ–∑ –±–æ–ª–∏ –∏ –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.',
          crappy: '–†–µ–ª–∏–∑ ‚Äî —Ä–∏—Å–∫–æ–≤–∞–Ω–Ω—ã–π, –±–æ–ª–µ–∑–Ω–µ–Ω–Ω—ã–π, –º–Ω–æ–≥–æ —Ä—É—á–Ω–æ–π —Ä–∞–±–æ—Ç—ã –∏ –∑–∞–Ω–∏–º–∞–µ—Ç –≤–µ—á–Ω–æ—Å—Ç—å.'
        },
        {
          id: 'suitable_process',
          title: '–ü–æ–¥—Ö–æ–¥—è—â–∏–π –ø—Ä–æ—Ü–µ—Å—Å',
          short: '–ü—Ä–æ—Ü–µ—Å—Å',
          awesome: '–ù–∞—à —Å–ø–æ—Å–æ–± —Ä–∞–±–æ—Ç—ã –Ω–∞–º –ø–æ–¥—Ö–æ–¥–∏—Ç –∏–¥–µ–∞–ª—å–Ω–æ.',
          crappy: '–ù–∞—à —Å–ø–æ—Å–æ–± —Ä–∞–±–æ—Ç—ã –Ω–∞–º –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç / ¬´–≤—Å—ë –Ω–µ —Ç–∞–∫¬ª.'
        },
        {
          id: 'tech_quality',
          title: '–¢–µ—Ö. –∫–∞—á–µ—Å—Ç–≤–æ (–∑–¥–æ—Ä–æ–≤—å–µ –∫–æ–¥–æ–≤–æ–π –±–∞–∑—ã)',
          short: '–ö–∞—á–µ—Å—Ç–≤–æ',
          awesome: '–ú—ã –≥–æ—Ä–¥–∏–º—Å—è –∫–∞—á–µ—Å—Ç–≤–æ–º –∫–æ–¥–∞: –æ–Ω —á–∏—Å—Ç—ã–π, —á–∏—Ç–∞–µ–º—ã–π, —Å —Ö–æ—Ä–æ—à–∏–º –ø–æ–∫—Ä—ã—Ç–∏–µ–º —Ç–µ—Å—Ç–∞–º–∏.',
          crappy: '–ö–æ–¥ –≤ –ø–ª–æ—Ö–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏, —Ç–µ—Ö–¥–æ–ª–≥ –≤—ã—Ö–æ–¥–∏—Ç –∏–∑-–ø–æ–¥ –∫–æ–Ω—Ç—Ä–æ–ª—è.'
        },
        {
          id: 'value',
          title: '–¶–µ–Ω–Ω–æ—Å—Ç—å',
          short: '–¶–µ–Ω–Ω–æ—Å—Ç—å',
          awesome: '–ú—ã –ø–æ—Å—Ç–∞–≤–ª—è–µ–º –æ—Ç–ª–∏—á–Ω—ã–µ –≤–µ—â–∏. –ú—ã —ç—Ç–∏–º –≥–æ—Ä–¥–∏–º—Å—è, —Å—Ç–µ–π–∫—Ö–æ–ª–¥–µ—Ä—ã –¥–æ–≤–æ–ª—å–Ω—ã.',
          crappy: '–ú—ã –ø–æ—Å—Ç–∞–≤–ª—è–µ–º ¬´–µ—Ä—É–Ω–¥—É¬ª, —Å—Ç—ã–¥–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç, —Å—Ç–µ–π–∫—Ö–æ–ª–¥–µ—Ä—ã –Ω–µ–¥–æ–≤–æ–ª—å–Ω—ã.'
        },
        {
          id: 'speed',
          title: '–°–∫–æ—Ä–æ—Å—Ç—å',
          short: '–°–∫–æ—Ä–æ—Å—Ç—å',
          awesome: '–ú—ã –¥–µ–ª–∞–µ–º –≤–µ—â–∏ –±—ã—Å—Ç—Ä–æ: –±–µ–∑ –æ–∂–∏–¥–∞–Ω–∏–π –∏ –∑–∞–¥–µ—Ä–∂–µ–∫.',
          crappy: '–ú—ã –Ω–∏—á–µ–≥–æ –Ω–µ –¥–æ–≤–æ–¥–∏–º –¥–æ –∫–æ–Ω—Ü–∞: –ø–æ—Å—Ç–æ—è–Ω–Ω–æ –∑–∞–ª–∏–ø–∞–µ–º –Ω–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è—Ö/–ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è—Ö.'
        },
        {
          id: 'mission',
          title: '–ú–∏—Å—Å–∏—è',
          short: '–ú–∏—Å—Å–∏—è',
          awesome: '–ú—ã —á—ë—Ç–∫–æ –ø–æ–Ω–∏–º–∞–µ–º, –∑–∞—á–µ–º –º—ã —Å—É—â–µ—Å—Ç–≤—É–µ–º, –∏ –Ω–∞—Å —ç—Ç–æ –≤–¥–æ—Ö–Ω–æ–≤–ª—è–µ—Ç.',
          crappy: '–ù–µ–ø–æ–Ω—è—Ç–Ω–æ, –∑–∞—á–µ–º –º—ã –∑–¥–µ—Å—å: –Ω–µ—Ç –æ–±—â–µ–π –∫–∞—Ä—Ç–∏–Ω—ã/—Ñ–æ–∫—É—Å–∞, –º–∏—Å—Å–∏—è –Ω–µ—è—Å–Ω–∞—è –∏ –Ω–µ –≤–¥–æ—Ö–Ω–æ–≤–ª—è–µ—Ç.'
        },
        {
          id: 'fun',
          title: '–§–∞–Ω',
          short: '–§–∞–Ω',
          awesome: '–ù–∞–º –Ω—Ä–∞–≤–∏—Ç—Å—è —Ä–∞–±–æ—Ç–∞—Ç—å –≤–º–µ—Å—Ç–µ, –∫–∞–π—Ñ—É–µ–º –æ—Ç –ø—Ä–æ—Ü–µ—Å—Å–∞.',
          crappy: '–°–∫—É—á–Ω–æ –∏ –Ω–µ–∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ.'
        },
        {
          id: 'learning',
          title: '–û–±—É—á–µ–Ω–∏–µ',
          short: '–û–±—É—á–µ–Ω–∏–µ',
          awesome: '–ú—ã –ø–æ—Å—Ç–æ—è–Ω–Ω–æ —É—á–∏–º—Å—è –∏ —É–∑–Ω–∞—ë–º –Ω–æ–≤–æ–µ.',
          crappy: '–£ –Ω–∞—Å –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ—Ç –≤—Ä–µ–º–µ–Ω–∏ —É—á–∏—Ç—å—Å—è.'
        },
        {
          id: 'support',
          title: '–ü–æ–¥–¥–µ—Ä–∂–∫–∞',
          short: '–ü–æ–¥–¥–µ—Ä–∂–∫–∞',
          awesome: '–ú—ã –±—ã—Å—Ç—Ä–æ –ø–æ–ª—É—á–∞–µ–º –ø–æ–º–æ—â—å/–ø–æ–¥–¥–µ—Ä–∂–∫—É, –∫–æ–≥–¥–∞ –æ–Ω–∞ –Ω—É–∂–Ω–∞.',
          crappy: '–ú—ã —Ä–µ–≥—É–ª—è—Ä–Ω–æ —Å—Ç–æ–ø–æ—Ä–∏–º—Å—è, –ø–æ—Ç–æ–º—É —á—Ç–æ –Ω–µ –º–æ–∂–µ–º –ø–æ–ª—É—á–∏—Ç—å –Ω—É–∂–Ω—É—é –ø–æ–¥–¥–µ—Ä–∂–∫—É.'
        },
        {
          id: 'pawns_or_players',
          title: '–ü–µ—à–∫–∏ –∏–ª–∏ –∏–≥—Ä–æ–∫–∏',
          short: '–í–ª–∏—è–Ω–∏–µ',
          awesome: '–ú—ã —É–ø—Ä–∞–≤–ª—è–µ–º —Å–≤–æ–µ–π —Å—É–¥—å–±–æ–π: —Ä–µ—à–∞–µ–º, —á—Ç–æ –∏ –∫–∞–∫ –¥–µ–ª–∞—Ç—å.',
          crappy: '–ú—ã ¬´–ø–µ—à–∫–∏¬ª: –ø–æ—á—Ç–∏ –Ω–µ –≤–ª–∏—è–µ–º –Ω–∞ —Ç–æ, —á—Ç–æ –∏ –∫–∞–∫ –º—ã –¥–µ–ª–∞–µ–º.'
        }
      ];

      const $ = (id) => document.getElementById(id);

      const autosaveStatus = $('autosaveStatus');
      const teamNameEl = $('teamName');
      const checkDateEl = $('checkDate');
      const facilitatorEl = $('facilitator');
      const globalNotesEl = $('globalNotes');
      const matrixEl = $('matrix');
      const matrixHeadEl = $('matrixHead');
      const matrixBodyEl = $('matrixBody');
      const btnExport = $('btnExport');
      const btnReset = $('btnReset');

      const tabMatrix = $('tabMatrix');
      const tabMulti = $('tabMulti');
      const sessionPanel = $('sessionPanel');
      const matrixPanel = $('matrixPanel');
      const multiPanel = $('multiPanel');
      const multiFiles = $('multiFiles');
      const multiDrop = $('multiDrop');
      const multiActions = $('multiActions');
      const multiTableWrap = $('multiTableWrap');
      const multiHeadEl = $('multiHead');
      const multiBodyEl = $('multiBody');
      const btnClearMulti = $('btnClearMulti');
      const btnExportMulti = $('btnExportMulti');

      function pad2(n){
        const s = String(n);
        return s.length >= 2 ? s : `0${s}`;
      }

      function todayISO(){
        const d = new Date();
        return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
      }

      function uid(){
        const rnd = Math.random().toString(16).slice(2);
        return `c_${Date.now().toString(16)}_${rnd}`;
      }

      function escapeCsvCell(v){
        const s = v == null ? '' : String(v);
        if (/[",\n\r]/.test(s)) return `"${s.replaceAll('"', '""')}"`;
        return s;
      }

      function buildFilename(meta){
        const date = meta.date || todayISO();
        const team = (meta.team || 'team').trim().replaceAll(/\s+/g, '_').replaceAll(/[^a-zA-Z0-9_\-–∞-—è–ê-–Ø]/g, '');
        return `team-health-check_${team || 'team'}_${date}.csv`;
      }

      function getGlobal(){
        return {
          team: teamNameEl ? teamNameEl.value : '',
          date: checkDateEl ? checkDateEl.value : '',
          facilitator: facilitatorEl ? facilitatorEl.value : '',
          overallNotes: globalNotesEl ? globalNotesEl.value : ''
        };
      }

      function setGlobal(g){
        const gg = g && typeof g === 'object' ? g : {};
        if (teamNameEl) teamNameEl.value = typeof gg.team === 'string' ? gg.team : '';
        if (checkDateEl) checkDateEl.value = typeof gg.date === 'string' ? gg.date : todayISO();
        if (facilitatorEl) facilitatorEl.value = typeof gg.facilitator === 'string' ? gg.facilitator : '';
        if (globalNotesEl) globalNotesEl.value = typeof gg.overallNotes === 'string' ? gg.overallNotes : '';
      }

      function getCellState(indicatorId, columnId){
        const status = document.querySelector(`input[name="${indicatorId}__${columnId}__status"]:checked`);
        const trend = document.querySelector(`select[name="${indicatorId}__${columnId}__trend"]`);
        const note = document.querySelector(`textarea[name="${indicatorId}__${columnId}__note"]`);
        return {
          status: status ? status.value : '',
          trend: trend ? trend.value : '',
          note: note ? note.value : ''
        };
      }

      function setCellState(indicatorId, columnId, s){
        const statusValue = s && typeof s.status === 'string' ? s.status : '';
        const trendValue = s && typeof s.trend === 'string' ? s.trend : '';
        const noteValue = s && typeof s.note === 'string' ? s.note : '';

        if (statusValue){
          const el = document.querySelector(`input[name="${indicatorId}__${columnId}__status"][value="${statusValue}"]`);
          if (el) el.checked = true;
        }
        const trendEl = document.querySelector(`select[name="${indicatorId}__${columnId}__trend"]`);
        if (trendEl) trendEl.value = trendValue;
        const noteEl = document.querySelector(`textarea[name="${indicatorId}__${columnId}__note"]`);
        if (noteEl) noteEl.value = noteValue;

        updateTrendUI(indicatorId, columnId);
      }

      function updateTrendUI(indicatorId, columnId){
        const status = document.querySelector(`input[name="${indicatorId}__${columnId}__status"]:checked`);
        const trendWrap = document.querySelector(`[data-trend-wrap="${indicatorId}__${columnId}"]`);
        const trendEl = document.querySelector(`select[name="${indicatorId}__${columnId}__trend"]`);

        const hasStatus = !!status;

        if (trendEl) trendEl.disabled = !hasStatus;
        if (trendWrap) trendWrap.classList.toggle('trendHidden', !hasStatus);

        updateNoteUI(indicatorId, columnId);
      }

      function updateNoteUI(indicatorId, columnId){
        const trendEl = document.querySelector(`select[name="${indicatorId}__${columnId}__trend"]`);
        const noteWrap = document.querySelector(`[data-note-wrap="${indicatorId}__${columnId}"]`);
        const hasTrend = !!(trendEl && trendEl.value);
        if (noteWrap) noteWrap.classList.toggle('noteHidden', !hasTrend);
      }

      function getParticipantMeta(participantId){
        const nameEl = document.querySelector(`input[name="p__${participantId}__name"]`);
        return {
          id: participantId,
          name: nameEl ? nameEl.value : ''
        };
      }

      function setParticipantMeta(participantId, meta){
        const m = meta && typeof meta === 'object' ? meta : {};
        const nameEl = document.querySelector(`input[name="p__${participantId}__name"]`);
        if (nameEl) nameEl.value = typeof m.name === 'string' ? m.name : '';
      }

      let state = {
        global: { team: '', date: todayISO(), facilitator: '', overallNotes: '' },
        columns: [],
        data: {}
      };

      function blankColumn(){
        const id = uid();
        return {
          id,
          name: ''
        };
      }

      function ensureStateShape(){
        if (!state || typeof state !== 'object') state = { global: { team: '', date: todayISO(), facilitator: '', overallNotes: '' }, columns: [], data: {} };
        if (!state.global || typeof state.global !== 'object') state.global = { team: '', date: todayISO(), facilitator: '', overallNotes: '' };
        if (!Array.isArray(state.columns)) state.columns = [];
        if (!state.data || typeof state.data !== 'object') state.data = {};

        if (!state.columns.length){
          state.columns = [blankColumn()];
        }
        for (const ind of indicators){
          if (!state.data[ind.id] || typeof state.data[ind.id] !== 'object') state.data[ind.id] = {};
          for (const col of state.columns){
            if (!state.data[ind.id][col.id] || typeof state.data[ind.id][col.id] !== 'object'){
              state.data[ind.id][col.id] = { status: '', trend: '', note: '' };
            }
          }
        }
      }

      function serialize(){
        const global = getGlobal();
        const columns = state.columns.map((c) => getParticipantMeta(c.id));
        const data = {};
        for (const ind of indicators){
          data[ind.id] = {};
          for (const col of state.columns){
            data[ind.id][col.id] = getCellState(ind.id, col.id);
          }
        }
        return { global, columns, data };
      }

      function applyState(saved){
        const s = saved && typeof saved === 'object' ? saved : null;
        state = {
          global: (s && s.global && typeof s.global === 'object') ? s.global : { team: '', date: todayISO(), facilitator: '', overallNotes: '' },
          columns: (s && Array.isArray(s.columns)) ? s.columns : [],
          data: (s && s.data && typeof s.data === 'object') ? s.data : {}
        };
        ensureStateShape();
        render();
        setGlobal(state.global);
        for (const col of state.columns){
          setParticipantMeta(col.id, col);
        }
        for (const ind of indicators){
          const perInd = state.data[ind.id] && typeof state.data[ind.id] === 'object' ? state.data[ind.id] : {};
          for (const col of state.columns){
            if (perInd && Object.prototype.hasOwnProperty.call(perInd, col.id)){
              setCellState(ind.id, col.id, perInd[col.id]);
            }
          }
        }
      }

      let autosaveTimer = null;
      function setAutosaveText(t){
        if (!autosaveStatus) return;
        autosaveStatus.textContent = t;
      }

      function scheduleAutosave(){
        if (autosaveTimer) window.clearTimeout(autosaveTimer);
        setAutosaveText('–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...');
        autosaveTimer = window.setTimeout(() => {
          try{
            localStorage.setItem(STORAGE_KEY, JSON.stringify(serialize()));
            setAutosaveText(`–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –ª–æ–∫–∞–ª—å–Ω–æ –≤ ${new Date().toLocaleTimeString()}`);
          }catch(_){
            setAutosaveText('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ localStorage');
          }
        }, 250);
      }

      function render(){
        if (!matrixHeadEl || !matrixBodyEl) return;

        matrixHeadEl.innerHTML = '';
        matrixBodyEl.innerHTML = '';

        const tr = document.createElement('tr');

        const th0 = document.createElement('th');
        th0.scope = 'col';
        th0.innerHTML = '';
        tr.appendChild(th0);

        for (const col of state.columns){
          const th = document.createElement('th');
          th.scope = 'col';

          th.innerHTML = `
            <div class="glassCard participantCard">
              <div class="glassPad">
                <div class="colHead">
                  <div class="colRow">
                    <div class="colTitle">–£—á–∞—Å—Ç–Ω–∏–∫</div>
                    <div class="colActions">
                      <button type="button" class="iconBtn" data-action="remove-column" data-col="${col.id}" aria-label="–£–¥–∞–ª–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞" title="–£–¥–∞–ª–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞">üóëÔ∏è</button>
                    </div>
                  </div>
                  <div class="colFields">
                    <div>
                      <label class="sr" for="p__${col.id}__name">–ò–º—è —É—á–∞—Å—Ç–Ω–∏–∫–∞</label>
                      <input id="p__${col.id}__name" name="p__${col.id}__name" type="text" autocomplete="name" placeholder="–ò–º—è" />
                    </div>
                  </div>
                </div>
              </div>
            </div>
          `;

          tr.appendChild(th);
        }

        {
          const thAdd = document.createElement('th');
          thAdd.scope = 'col';
          thAdd.innerHTML = `
            <div class="glassCard participantCard">
              <div class="glassPad" style="display:flex; align-items:center; justify-content:center; min-height: 74px;">
                <button type="button" class="plusBtn" data-action="add-column" aria-label="–î–æ–±–∞–≤–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞">+</button>
              </div>
            </div>
          `;
          tr.appendChild(thAdd);
        }

        matrixHeadEl.appendChild(tr);

        for (const ind of indicators){
          const row = document.createElement('tr');

          const th = document.createElement('th');
          th.scope = 'row';
          th.innerHTML = `
            <div class="glassCard indicatorFixed">
              <div class="glassPad indicatorCard">
                <div class="indicatorTitleV" aria-hidden="true">${ind.short || ind.title}</div>
                <div class="indicatorText">
                  <div class="indTitle">${ind.title}</div>
                  <div class="indMeta"><span class="k">–û—Ç–ª–∏—á–Ω–æ:</span> ${ind.awesome}</div>
                  <div class="indMeta"><span class="k">–ü–ª–æ—Ö–æ:</span> ${ind.crappy}</div>
                </div>
              </div>
            </div>
          `;
          row.appendChild(th);

          for (const col of state.columns){
            const td = document.createElement('td');

            const sName = `${ind.id}__${col.id}__status`;
            const tName = `${ind.id}__${col.id}__trend`;
            const nName = `${ind.id}__${col.id}__note`;

            td.innerHTML = `
              <div class="glassCard cellFixed">
                <div class="glassPad">
                  <div class="cell">
                    <div>
                      <div class="sr">Status</div>
                      <div class="statusDots" role="radiogroup" aria-label="${ind.title}: —Å—Ç–∞—Ç—É—Å">
                        <input id="${sName}__green" type="radio" name="${sName}" value="green" />
                        <label class="dotLbl" for="${sName}__green" aria-label="Green"><span class="dot ok" aria-hidden="true"></span></label>

                        <input id="${sName}__yellow" type="radio" name="${sName}" value="yellow" />
                        <label class="dotLbl" for="${sName}__yellow" aria-label="Yellow"><span class="dot warn" aria-hidden="true"></span></label>

                        <input id="${sName}__red" type="radio" name="${sName}" value="red" />
                        <label class="dotLbl" for="${sName}__red" aria-label="Red"><span class="dot bad" aria-hidden="true"></span></label>
                      </div>
                    </div>

                    <div class="trendHidden" data-trend-wrap="${ind.id}__${col.id}">
                      <label class="sr" for="${tName}__sel">–¢—Ä–µ–Ω–¥</label>
                      <select id="${tName}__sel" name="${tName}" aria-label="${ind.title}: —Ç—Ä–µ–Ω–¥" disabled>
                        <option value="">‚Äî</option>
                        <option value="up">‚Üó –£–ª—É—á—à–∞–µ—Ç—Å—è</option>
                        <option value="stable">‚Üí –°—Ç–∞–±–∏–ª—å–Ω–æ</option>
                        <option value="down">‚Üò –£—Ö—É–¥—à–∞–µ—Ç—Å—è</option>
                      </select>
                    </div>

                    <div class="noteHidden" data-note-wrap="${ind.id}__${col.id}">
                      <details>
                        <summary>–ó–∞–º–µ—Ç–∫–∞</summary>
                        <div class="noteBody">
                          <label class="sr" for="${nName}">–ó–∞–º–µ—Ç–∫–∞</label>
                          <textarea id="${nName}" name="${nName}"></textarea>
                        </div>
                      </details>
                    </div>
                  </div>
                </div>
              </div>
            `;

            row.appendChild(td);
          }

          matrixBodyEl.appendChild(row);
        }

        // Apply gate logic after DOM is in place
        for (const ind of indicators){
          for (const col of state.columns){
            updateTrendUI(ind.id, col.id);
            updateNoteUI(ind.id, col.id);
          }
        }
      }

      function validateForExport(){
        const invalid = [];
        for (const ind of indicators){
          for (const col of state.columns){
            const s = getCellState(ind.id, col.id);
            const p = getParticipantMeta(col.id);
            if (!s.status) invalid.push(`${ind.title} / ${p && p.name ? p.name : '–£—á–∞—Å—Ç–Ω–∏–∫'}`);
          }
        }
        return invalid;
      }

      function exportCsv(){
        const global = getGlobal();
        const missing = validateForExport();

        if (missing.length){
          const msg = `–ù–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (–∑–µ–ª/–∂—ë–ª—Ç/–∫—Ä–∞—Å–Ω) –¥–ª—è ${missing.length} –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤.\n\n–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —ç–∫—Å–ø–æ—Ä—Ç?`;
          if (!window.confirm(msg)) return;
        }

        const header = ['participant_id','participant_name','team','date','facilitator','indicator','status','trend','note','overall_notes'];
        const rows = [header];

        for (const ind of indicators){
          for (const col of state.columns){
            const p = getParticipantMeta(col.id);
            const s = getCellState(ind.id, col.id);
            rows.push([
              col.id,
              (p && p.name) ? p.name : '',
              global.team || '',
              global.date || '',
              global.facilitator || '',
              ind.title,
              s.status,
              s.trend,
              s.note,
              global.overallNotes || ''
            ]);
          }
        }

        const csv = rows.map((r) => r.map(escapeCsvCell).join(',')).join('\n');
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = buildFilename({ team: global.team || 'team', date: global.date || todayISO() });
        a.className = 'sr';
        a.textContent = 'download';
        document.body.appendChild(a);
        a.click();
        a.remove();
        window.setTimeout(() => URL.revokeObjectURL(url), 0);
      }

      function resetAll(){
        const ok = window.confirm('–°–±—Ä–æ—Å–∏—Ç—å —Ñ–æ—Ä–º—É –∏ –ª–æ–∫–∞–ª—å–Ω–æ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ?');
        if (!ok) return;
        try{ localStorage.removeItem(STORAGE_KEY); }catch(_){ }
        try{ localStorage.removeItem(LEGACY_STORAGE_KEY); }catch(_){ }
        applyState({ global: { team: '', date: todayISO(), facilitator: '', overallNotes: '' }, columns: [blankColumn()], data: {} });
        setAutosaveText('–°–±—Ä–æ—à–µ–Ω–æ');
      }

      function bindAutosave(){
        const root = document.body;
        if (!root) return;
        root.addEventListener('input', (e) => {
          const t = e.target;
          if (!t) return;
          if (t.matches('input, textarea, select')) scheduleAutosave();
        });
        root.addEventListener('change', (e) => {
          const t = e.target;
          if (!t) return;
          if (t.matches('input[type="radio"], input[type="date"], input[type="text"], select')) scheduleAutosave();
        });

        if (!matrixEl) return;
        matrixEl.addEventListener('change', (e) => {
          const t = e.target;
          if (!t) return;
          if (t instanceof HTMLInputElement && t.type === 'radio'){
            const name = t.getAttribute('name') || '';
            const parts = name.split('__');
            if (parts.length === 3 && parts[2] === 'status'){
              const indicatorId = parts[0];
              const columnId = parts[1];
              updateTrendUI(indicatorId, columnId);
            }
          }
          if (t instanceof HTMLSelectElement){
            const name = t.getAttribute('name') || '';
            const parts = name.split('__');
            if (parts.length === 3 && parts[2] === 'trend'){
              const indicatorId = parts[0];
              const columnId = parts[1];
              updateNoteUI(indicatorId, columnId);
            }
          }
        });
      }

      function addColumn(){
        state = serialize();
        const col = blankColumn();
        state.columns.push(col);
        ensureStateShape();
        render();
        setGlobal(state.global);
        for (const c of state.columns){
          setParticipantMeta(c.id, c);
        }
        for (const ind of indicators){
          for (const c of state.columns){
            setCellState(ind.id, c.id, (state.data[ind.id] && state.data[ind.id][c.id]) ? state.data[ind.id][c.id] : { status: '', trend: '', note: '' });
          }
        }
        scheduleAutosave();
      }

      function removeColumn(columnId){
        state = serialize();
        if (state.columns.length <= 1){
          window.alert('–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é –∫–æ–ª–æ–Ω–∫—É.');
          return;
        }
        const ok = window.confirm('–£–¥–∞–ª–∏—Ç—å –∫–æ–ª–æ–Ω–∫—É? –î–∞–Ω–Ω—ã–µ –≤ –Ω–µ–π –±—É–¥—É—Ç –ø–æ—Ç–µ—Ä—è–Ω—ã.');
        if (!ok) return;
        state.columns = state.columns.filter((c) => c.id !== columnId);
        for (const ind of indicators){
          if (state.data[ind.id] && typeof state.data[ind.id] === 'object'){
            delete state.data[ind.id][columnId];
          }
        }
        ensureStateShape();
        render();
        setGlobal(state.global);
        for (const c of state.columns){
          setParticipantMeta(c.id, c);
        }
        for (const ind of indicators){
          for (const c of state.columns){
            setCellState(ind.id, c.id, (state.data[ind.id] && state.data[ind.id][c.id]) ? state.data[ind.id][c.id] : { status: '', trend: '', note: '' });
          }
        }
        scheduleAutosave();
      }

      function bindMatrixActions(){
        if (!matrixEl) return;
        matrixEl.addEventListener('click', (e) => {
          const t = e.target;
          if (!t || !(t instanceof HTMLElement)) return;
          const action = t.getAttribute('data-action');
          if (action === 'add-column'){
            addColumn();
            return;
          }
          if (action === 'remove-column'){
            const col = t.getAttribute('data-col');
            if (col) removeColumn(col);
          }
        });
      }

      function migrateLegacyIfNeeded(){
        let hasNew = false;
        try{ hasNew = !!localStorage.getItem(STORAGE_KEY); }catch(_){ hasNew = false; }
        if (hasNew) return;

        let legacyRaw = null;
        try{ legacyRaw = localStorage.getItem(LEGACY_STORAGE_KEY); }catch(_){ legacyRaw = null; }
        if (!legacyRaw) return;

        try{
          const legacy = JSON.parse(legacyRaw);
          const meta = legacy && legacy.meta && typeof legacy.meta === 'object' ? legacy.meta : {};
          const col = blankColumn();
          col.name = '–£—á–∞—Å—Ç–Ω–∏–∫';

          const data = {};
          for (const ind of indicators){
            const v = legacy && legacy.data && legacy.data[ind.id] ? legacy.data[ind.id] : { status: '', trend: '', note: '' };
            data[ind.id] = { [col.id]: { status: v.status || '', trend: v.trend || '', note: v.note || '' } };
          }

          const migrated = {
            global: {
              team: typeof meta.team === 'string' ? meta.team : '',
              date: typeof meta.date === 'string' ? meta.date : todayISO(),
              facilitator: typeof meta.facilitator === 'string' ? meta.facilitator : '',
              overallNotes: typeof meta.overallNotes === 'string' ? meta.overallNotes : ''
            },
            columns: [col],
            data
          };
          try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(migrated)); }catch(_){ }
        }catch(_){ }
      }

      function migrateMatrixToParticipantsIfNeeded(){
        let raw = null;
        try{ raw = localStorage.getItem(STORAGE_KEY); }catch(_){ raw = null; }
        if (!raw) return;

        try{
          const saved = JSON.parse(raw);
          const cols = saved && Array.isArray(saved.columns) ? saved.columns : null;
          const global = saved && saved.global && typeof saved.global === 'object' ? saved.global : null;
          const isOldMatrix = !!cols && cols.length && (Object.prototype.hasOwnProperty.call(cols[0], 'title') || Object.prototype.hasOwnProperty.call(cols[0], 'team'));
          if (!isOldMatrix) return;

          const newGlobal = {
            team: (global && typeof global.team === 'string') ? global.team : '',
            date: (global && typeof global.date === 'string') ? global.date : todayISO(),
            facilitator: (global && typeof global.facilitator === 'string') ? global.facilitator : '',
            overallNotes: (global && typeof global.overallNotes === 'string') ? global.overallNotes : ''
          };

          // Try to recover team/date/facilitator from the first old column
          const first = cols[0];
          if (first && typeof first === 'object'){
            if (!newGlobal.team && typeof first.team === 'string') newGlobal.team = first.team;
            if (typeof first.date === 'string') newGlobal.date = first.date;
            if (!newGlobal.facilitator && typeof first.facilitator === 'string') newGlobal.facilitator = first.facilitator;
          }

          const newCols = cols.map((c) => ({
            id: c.id,
            name: (typeof c.title === 'string' && c.title.trim()) ? c.title.trim() : (typeof c.name === 'string' ? c.name : '')
          }));

          const migrated = {
            global: newGlobal,
            columns: newCols,
            data: saved.data && typeof saved.data === 'object' ? saved.data : {}
          };
          localStorage.setItem(STORAGE_KEY, JSON.stringify(migrated));
        }catch(_){ }
      }

      migrateLegacyIfNeeded();
      migrateMatrixToParticipantsIfNeeded();

      const savedRaw = (() => {
        try{ return localStorage.getItem(STORAGE_KEY); }catch(_){ return null; }
      })();
      if (savedRaw){
        try{
          const saved = JSON.parse(savedRaw);
          applyState(saved);
          setAutosaveText('–ó–∞–≥—Ä—É–∂–µ–Ω–æ –∏–∑ localStorage');
        }catch(_){
          applyState({ global: { team: '', date: todayISO(), facilitator: '', overallNotes: '' }, columns: [blankColumn()], data: {} });
          setAutosaveText('');
        }
      } else {
        applyState({ global: { team: '', date: todayISO(), facilitator: '', overallNotes: '' }, columns: [blankColumn()], data: {} });
      }

      bindAutosave();
      bindMatrixActions();

      if (btnExport) btnExport.addEventListener('click', exportCsv);
      if (btnReset) btnReset.addEventListener('click', resetAll);

      function setSelectedTab(which){
        const isMatrix = which === 'matrix';
        const isMulti = which === 'multi';
        if (tabMatrix) tabMatrix.setAttribute('aria-selected', isMatrix ? 'true' : 'false');
        if (tabMulti) tabMulti.setAttribute('aria-selected', isMulti ? 'true' : 'false');
      }

      function setView(which, opts){
        setSelectedTab(which);

        if (sessionPanel) sessionPanel.style.display = (which === 'multi') ? 'none' : '';
        if (matrixPanel) matrixPanel.style.display = (which === 'matrix') ? '' : 'none';
        if (multiPanel) multiPanel.style.display = (which === 'multi') ? '' : 'none';

        if (which === 'multi') renderMultiSummary();

        const shouldScroll = !opts || opts.scroll !== false;
        if (!shouldScroll) return;

        const el = (which === 'matrix') ? matrixPanel : multiPanel;
        if (el) el.scrollIntoView({ block: 'start' });
      }

      function bindTabs(){
        if (tabMatrix) tabMatrix.addEventListener('click', () => setView('matrix'));
        if (tabMulti) tabMulti.addEventListener('click', () => setView('multi'));
      }

      function parseCsv(text){
        const rows = [];
        let row = [];
        let cur = '';
        let inQ = false;
        for (let i = 0; i < text.length; i++){
          const ch = text[i];
          if (inQ){
            if (ch === '"'){
              const next = text[i+1];
              if (next === '"'){
                cur += '"';
                i++;
              } else {
                inQ = false;
              }
            } else {
              cur += ch;
            }
            continue;
          }

          if (ch === '"'){
            inQ = true;
            continue;
          }
          if (ch === ','){
            row.push(cur);
            cur = '';
            continue;
          }
          if (ch === '\n'){
            row.push(cur);
            cur = '';
            if (row.length > 1 || row.some((v) => v.trim() !== '')) rows.push(row);
            row = [];
            continue;
          }
          if (ch === '\r') continue;
          cur += ch;
        }
        row.push(cur);
        if (row.length > 1 || row.some((v) => v.trim() !== '')) rows.push(row);
        return rows;
      }

      function normalizeHeader(h){
        return String(h || '').trim().toLowerCase();
      }

      function rowsToObjects(rows){
        if (!rows || rows.length < 2) return [];
        const header = rows[0].map(normalizeHeader);
        const out = [];
        for (let i = 1; i < rows.length; i++){
          const r = rows[i];
          const o = {};
          for (let j = 0; j < header.length; j++){
            o[header[j]] = (r[j] == null) ? '' : String(r[j]);
          }
          out.push(o);
        }
        return out;
      }

      let multiAgg = new Map();

      function getMultiBucket(team, date, indicator){
        const t = team || '‚Äî';
        const d = date || '‚Äî';
        const i = indicator || '‚Äî';
        const key = `${t}__${d}__${i}`;
        const prev = multiAgg.get(key) || { team: t, date: d, indicator: i, green: 0, yellow: 0, red: 0, trendCounts: { up: 0, stable: 0, down: 0 }, responses: 0, votes: [] };
        multiAgg.set(key, prev);
        return prev;
      }

      function addParticipantExport(objects){
        for (const o of objects){
          const team = (o.team || '').trim() || '‚Äî';
          const date = (o.date || '').trim() || '‚Äî';
          const indicator = (o.indicator || '').trim() || '‚Äî';
          const status = (o.status || '').trim();
          const trend = (o.trend || '').trim();
          const participantName = (o.participant_name || '').trim();
          const participantId = (o.participant_id || '').trim();
          const note = (o.note || '').trim();
          const prev = getMultiBucket(team, date, indicator);
          if (status === 'green') prev.green++;
          if (status === 'yellow') prev.yellow++;
          if (status === 'red') prev.red++;
          if (trend && Object.prototype.hasOwnProperty.call(prev.trendCounts, trend)) prev.trendCounts[trend]++;
          prev.responses++;
          if (Array.isArray(prev.votes)){
            prev.votes.push({
              participantId,
              participantName,
              status,
              trend,
              note
            });
          }
        }
      }

      function addSummaryExport(objects){
        for (const o of objects){
          const team = (o.team || '').trim() || '‚Äî';
          const date = (o.date || '').trim() || '‚Äî';
          const indicator = (o.indicator || '').trim() || '‚Äî';
          const prev = getMultiBucket(team, date, indicator);

          const green = Number(o.green || 0) || 0;
          const yellow = Number(o.yellow || 0) || 0;
          const red = Number(o.red || 0) || 0;
          const responses = green + yellow + red;

          prev.green += green;
          prev.yellow += yellow;
          prev.red += red;
          prev.responses += responses;

          const tr = (o.trend || '').trim();
          if (tr.includes('‚Üó')) prev.trendCounts.up++;
          if (tr.includes('‚Üí')) prev.trendCounts.stable++;
          if (tr.includes('‚Üò')) prev.trendCounts.down++;
        }
      }

      function dominantTrendLabel(trendCounts){
        const entries = Object.entries(trendCounts);
        entries.sort((a, b) => b[1] - a[1]);
        const top = entries[0];
        if (!top || top[1] === 0) return '‚Äî';
        if (top[0] === 'up') return '‚Üó –£–ª—É—á—à–∞–µ—Ç—Å—è';
        if (top[0] === 'stable') return '‚Üí –°—Ç–∞–±–∏–ª—å–Ω–æ';
        if (top[0] === 'down') return '‚Üò –£—Ö—É–¥—à–∞–µ—Ç—Å—è';
        return '‚Äî';
      }

      function worstTrendLabel(trendCounts){
        if (!trendCounts || typeof trendCounts !== 'object') return '‚Äî';
        if ((trendCounts.down || 0) > 0) return '‚Üò –£—Ö—É–¥—à–∞–µ—Ç—Å—è';
        if ((trendCounts.stable || 0) > 0) return '‚Üí –°—Ç–∞–±–∏–ª—å–Ω–æ';
        if ((trendCounts.up || 0) > 0) return '‚Üó –£–ª—É—á—à–∞–µ—Ç—Å—è';
        return '‚Äî';
      }

      function pickMajorityStatus(bucket){
        if (!bucket) return '';
        const g = bucket.green || 0;
        const y = bucket.yellow || 0;
        const r = bucket.red || 0;
        const max = Math.max(g, y, r);
        if (max === 0) return '';
        if (g === max) return 'green';
        if (y === max) return 'yellow';
        return 'red';
      }

      function worstStatus(bucket){
        if (!bucket) return '';
        if ((bucket.red || 0) > 0) return 'red';
        if ((bucket.yellow || 0) > 0) return 'yellow';
        if ((bucket.green || 0) > 0) return 'green';
        return '';
      }

      function labelStatusRu(s){
        if (s === 'green') return '–ó–µ–ª—ë–Ω—ã–π';
        if (s === 'yellow') return '–ñ—ë–ª—Ç—ã–π';
        if (s === 'red') return '–ö—Ä–∞—Å–Ω—ã–π';
        return '‚Äî';
      }

      function labelTrendRu(t){
        if (t === 'up') return '‚Üó –£–ª—É—á—à–∞–µ—Ç—Å—è';
        if (t === 'stable') return '‚Üí –°—Ç–∞–±–∏–ª—å–Ω–æ';
        if (t === 'down') return '‚Üò –£—Ö—É–¥—à–∞–µ—Ç—Å—è';
        return '‚Äî';
      }

      function escapeAttr(s){
        return String(s == null ? '' : s)
          .replaceAll('&', '&amp;')
          .replaceAll('"', '&quot;')
          .replaceAll('<', '&lt;')
          .replaceAll('>', '&gt;');
      }

      function pickLatestDatePerTeam(){
        const m = new Map();
        for (const b of multiAgg.values()){
          const team = b.team || '‚Äî';
          const date = b.date || '‚Äî';
          if (m.has(team)){
            const prev = m.get(team);
            if (prev < date) m.set(team, date);
          } else {
            m.set(team, date);
          }
        }
        return m;
      }

      function getBucket(team, date, indicator){
        const t = (team || '‚Äî');
        const d = (date || '‚Äî');
        const i = (indicator || '‚Äî');
        return multiAgg.get(`${t}__${d}__${i}`) || null;
      }

      function renderMultiSummary(){
        if (!multiBodyEl || !multiHeadEl) return;
        multiHeadEl.innerHTML = '';
        multiBodyEl.innerHTML = '';

        const latest = pickLatestDatePerTeam();
        const teams = Array.from(latest.keys()).sort((a, b) => a.localeCompare(b));

        const hasData = !!teams.length;
        if (multiActions) multiActions.style.display = hasData ? '' : 'none';
        if (multiTableWrap) multiTableWrap.classList.toggle('multiWrapHidden', !hasData);
        if (multiDrop) multiDrop.style.display = hasData ? 'none' : '';
        if (!hasData) return;

        const hr = document.createElement('tr');
        const h0 = document.createElement('th');
        h0.scope = 'col';
        h0.innerHTML = `<div class="glassCard"><div class="glassPad smPad"><strong>–ö—Ä–∏—Ç–µ—Ä–∏–π</strong></div></div>`;
        hr.appendChild(h0);
        for (const team of teams){
          const date = latest.get(team);
          const th = document.createElement('th');
          th.scope = 'col';
          th.innerHTML = `<div class="glassCard"><div class="glassPad smPad"><strong>${team}</strong><div class="indMeta" style="margin-top:4px;">${date || ''}</div></div></div>`;
          hr.appendChild(th);
        }
        multiHeadEl.appendChild(hr);

        for (const ind of indicators){
          const tr = document.createElement('tr');
          const th = document.createElement('th');
          th.scope = 'row';
          const indTip = `–û—Ç–ª–∏—á–Ω–æ: ${ind.awesome}\n–ü–ª–æ—Ö–æ: ${ind.crappy}`;
          th.innerHTML = `<div class="glassCard"><div class="glassPad smPadTight" title="${escapeAttr(indTip)}"><strong>${escapeAttr(ind.title)}</strong></div></div>`;
          tr.appendChild(th);

          for (const team of teams){
            const date = latest.get(team);
            const b = getBucket(team, date, ind.title);
            const status = worstStatus(b);
            const trendLabel = b ? worstTrendLabel(b.trendCounts) : '‚Äî';

            const cls = status === 'green' ? 'ok' : status === 'yellow' ? 'warn' : status === 'red' ? 'bad' : '';
            const trendChar = trendLabel.includes('‚Üó') ? '‚Üó' : trendLabel.includes('‚Üò') ? '‚Üò' : trendLabel.includes('‚Üí') ? '‚Üí' : '‚Äî';
            const aria = `${team}${date ? `, ${date}` : ''}: ${ind.title}. –°—Ç–∞—Ç—É—Å: ${labelStatusRu(status)}. –¢—Ä–µ–Ω–¥: ${trendLabel || '‚Äî'}.`;

            const tip = (() => {
              if (!b) return '';
              const votes = Array.isArray(b.votes) ? b.votes : [];
              if (votes.length){
                const lines = votes.map((v) => {
                  const who = (v.participantName || v.participantId || '–£—á–∞—Å—Ç–Ω–∏–∫').trim();
                  const st = labelStatusRu(v.status);
                  const tr = labelTrendRu(v.trend);
                  return `${who}: ${st}, ${tr}`;
                });
                return lines.join('\n');
              }
              return `Green: ${b.green || 0}\nYellow: ${b.yellow || 0}\nRed: ${b.red || 0}`;
            })();

            const td = document.createElement('td');
            td.innerHTML = `
              <div class="glassCard">
                <div class="glassPad">
                  <div class="sumCell" aria-label="${escapeAttr(aria)}" title="${escapeAttr(tip)}">
                    <span class="sumDot ${cls}" aria-hidden="true"></span>
                    <span class="sumTrend" aria-hidden="true">${trendChar}</span>
                  </div>
                </div>
              </div>
            `;
            tr.appendChild(td);
          }

          multiBodyEl.appendChild(tr);
        }
      }

      async function handleMultiFiles(files){
        const list = Array.from(files || []);
        if (!list.length) return;
        for (const f of list){
          const text = await f.text();
          const rows = parseCsv(text);
          const objects = rowsToObjects(rows);
          const header = rows && rows[0] ? rows[0].map(normalizeHeader) : [];

          if (header.includes('participant_id') && header.includes('indicator') && header.includes('status')){
            addParticipantExport(objects);
          } else if (header.includes('green') && header.includes('yellow') && header.includes('red') && header.includes('indicator')){
            addSummaryExport(objects);
          }
        }
        renderMultiSummary();
      }

      function clearMulti(){
        multiAgg = new Map();
        if (multiFiles) multiFiles.value = '';
        renderMultiSummary();
      }

      function exportMultiCsv(){
        const latest = pickLatestDatePerTeam();
        const teams = Array.from(latest.keys()).sort((a, b) => a.localeCompare(b));
        const header = ['team','date','indicator','status','trend','green','yellow','red','responses'];
        const rows = [header];

        for (const team of teams){
          const date = latest.get(team);
          for (const ind of indicators){
            const b = getBucket(team, date, ind.title);
            const status = worstStatus(b);
            const trend = b ? worstTrendLabel(b.trendCounts) : '';
            rows.push([
              team,
              date || '',
              ind.title,
              status,
              trend,
              String(b ? b.green : 0),
              String(b ? b.yellow : 0),
              String(b ? b.red : 0),
              String(b ? b.responses : 0)
            ]);
          }
        }
        const csv = rows.map((r) => r.map(escapeCsvCell).join(',')).join('\n');
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `team-health-check_multi_summary_${todayISO()}.csv`;
        a.className = 'sr';
        a.textContent = 'download';
        document.body.appendChild(a);
        a.click();
        a.remove();
        window.setTimeout(() => URL.revokeObjectURL(url), 0);
      }

      bindTabs();
      setView('matrix', { scroll: false });

      if (multiFiles) multiFiles.addEventListener('change', (e) => {
        const t = e.target;
        if (!t || !(t instanceof HTMLInputElement)) return;
        if (t.files) handleMultiFiles(t.files);
      });

      if (multiDrop){
        const prevent = (e) => {
          e.preventDefault();
          e.stopPropagation();
        };

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach((type) => {
          multiDrop.addEventListener(type, prevent);
        });

        multiDrop.addEventListener('dragenter', () => multiDrop.classList.add('dragover'));
        multiDrop.addEventListener('dragover', () => multiDrop.classList.add('dragover'));
        multiDrop.addEventListener('dragleave', () => multiDrop.classList.remove('dragover'));
        multiDrop.addEventListener('drop', (e) => {
          multiDrop.classList.remove('dragover');
          const dt = e.dataTransfer;
          if (!dt || !dt.files) return;
          handleMultiFiles(dt.files);
        });
      }
      if (btnClearMulti) btnClearMulti.addEventListener('click', clearMulti);
      if (btnExportMulti) btnExportMulti.addEventListener('click', exportMultiCsv);
    })();
  </script>
</body>
</html>
