<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Team Health Check (Spotify model) — CSV export</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Fraunces:ital,opsz,wght@0,9..144,100..900;1,9..144,100..900&family=DM+Sans:ital,opsz,wght@0,9..40,100..1000;1,9..40,100..1000&display=swap" rel="stylesheet" />
  <style>
    /* ===== RESET ===== */
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    /* ===== CUSTOM PROPERTIES ===== */
    :root {
      --bg: #FAF6F1;
      --text: #2D2319;
      --accent: #C4593A;
      --ok: #5A8A58;
      --warn: #C9963A;
      --bad: #BE4D3A;
      --card: #FFFFFF;
      --card-shadow: 0 8px 32px rgba(45,35,25,0.08);
      --radius: 18px;
      --radius-sm: 12px;
      --muted: rgba(45,35,25,0.55);
      --stroke: rgba(45,35,25,0.10);
    }

    /* ===== CANVAS GRAIN (inline SVG filter) ===== */
    body::after {
      content: '';
      position: fixed;
      inset: 0;
      z-index: 9999;
      pointer-events: none;
      opacity: 0.028;
      background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='300' height='300'%3E%3Cfilter id='g'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.75' numOctaves='4' stitchTiles='stitch'/%3E%3CfeColorMatrix type='saturate' values='0'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23g)'/%3E%3C/svg%3E");
      background-repeat: repeat;
    }

    /* ===== BASE TYPOGRAPHY & BODY ===== */
    html, body {
      min-height: 100%;
      background: var(--bg);
      color: var(--text);
      font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
      font-size: 15px;
      line-height: 1.55;
    }

    body {
      min-height: 100dvh;
      display: flex;
      flex-direction: column;
    }

    h1, h2, h3, h4, h5, h6 {
      font-family: 'Fraunces', Georgia, 'Times New Roman', serif;
      font-weight: 700;
      line-height: 1.25;
    }

    a {
      color: var(--accent);
      text-decoration: underline;
      text-underline-offset: 2px;
    }
    a:hover {
      text-decoration-thickness: 2px;
    }
    a:focus-visible {
      outline: 2px dashed var(--accent);
      outline-offset: 3px;
    }

    /* ===== SCREEN READER ONLY ===== */
    .sr {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0,0,0,0);
      white-space: nowrap;
      border: 0;
    }

    /* ===== SKIP LINK ===== */
    .skip {
      position: absolute;
      top: 0;
      left: 0;
      transform: translateY(-120%);
      padding: 10px 14px;
      background: var(--text);
      color: var(--bg);
      border-radius: 0 0 var(--radius-sm) 0;
      font-weight: 600;
      z-index: 50;
      text-decoration: none;
    }
    .skip:focus {
      transform: translateY(0);
    }

    /* ===== HEADER ===== */
    header {
      padding: 16px clamp(16px, 4vw, 32px);
      border-bottom: 1px solid var(--stroke);
      background: rgba(250,246,241,0.88);
      backdrop-filter: blur(12px);
      position: sticky;
      top: 0;
      z-index: 10;
    }
    header .row {
      display: flex;
      gap: 16px;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      max-width: 1100px;
      margin: 0 auto;
    }
    header h1 {
      font-size: clamp(18px, 2.4vw, 26px);
      font-optical-sizing: auto;
      letter-spacing: -0.01em;
    }

    /* Mode toggle (center pills) */
    .modeToggle {
      display: inline-flex;
      gap: 0;
      padding: 4px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,0.6);
    }
    .modeBtn {
      border-radius: 999px;
      padding: 7px 16px;
      border: none;
      background: transparent;
      color: var(--text);
      font: inherit;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      line-height: 1;
      white-space: nowrap;
      transition: background 0.15s, box-shadow 0.15s;
    }
    .modeBtn[aria-pressed="true"] {
      background: var(--card);
      box-shadow: 0 2px 8px rgba(45,35,25,0.10);
    }
    .modeBtn:focus-visible {
      outline: 2px dashed var(--accent);
      outline-offset: 2px;
    }

    /* Language toggle (right) */
    .langToggle {
      display: inline-flex;
      gap: 4px;
      padding: 4px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,0.6);
    }
    .langBtn {
      border-radius: 999px;
      padding: 7px 10px;
      border: none;
      background: transparent;
      color: var(--text);
      font: inherit;
      font-size: 13px;
      font-weight: 700;
      cursor: pointer;
      line-height: 1;
      white-space: nowrap;
      transition: background 0.15s, box-shadow 0.15s;
    }
    .langBtn[aria-pressed="true"] {
      background: var(--card);
      box-shadow: 0 2px 8px rgba(45,35,25,0.10);
    }
    .langBtn:focus-visible {
      outline: 2px dashed var(--accent);
      outline-offset: 2px;
    }

    /* ===== MAIN ===== */
    main#main {
      flex: 1 1 auto;
      padding: 24px clamp(16px, 4vw, 32px) 40px;
    }
    .wrap {
      max-width: 1100px;
      margin: 0 auto;
    }

    /* ===== SCREEN VISIBILITY ===== */
    .screen {
      display: none;
    }
    .screen.active {
      display: block;
    }

    /* ===== FOOTER ===== */
    footer {
      padding: 16px clamp(16px, 4vw, 32px) 24px;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.5;
      border-top: 1px solid var(--stroke);
    }
    footer .wrap {
      max-width: 1100px;
      margin: 0 auto;
    }
    footer .row {
      display: flex;
      gap: 16px;
      align-items: baseline;
      justify-content: space-between;
      flex-wrap: wrap;
    }
    footer a {
      color: var(--accent);
      text-decoration: underline;
    }
    footer a:hover {
      text-decoration-thickness: 2px;
    }

    /* ===== SETUP SCREEN ===== */
    .setup-card {
      background: var(--card);
      box-shadow: var(--card-shadow);
      border-radius: var(--radius);
      margin: 60px auto 0;
      padding: 40px;
      max-width: 560px;
    }
    .setup-fields {
      display: flex;
      flex-direction: column;
      gap: 20px;
      margin-bottom: 28px;
    }
    .field label {
      display: block;
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 6px;
      font-weight: 500;
    }
    .field input {
      width: 100%;
      border: none;
      border-bottom: 2px solid rgba(45,35,25,0.12);
      background: transparent;
      padding: 10px 0;
      font: inherit;
      font-size: 16px;
      color: var(--text);
      outline: none;
      transition: border-color 0.15s;
    }
    .field input:focus {
      border-bottom-color: var(--accent);
    }
    .participants-section {
      margin-bottom: 28px;
    }
    .participants-section h3 {
      font-size: 15px;
      margin-bottom: 12px;
    }
    .chip-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 8px 8px 12px;
      border-radius: var(--radius-sm);
      background: rgba(45,35,25,0.05);
      font-size: 14px;
      transition: background 0.15s;
    }
    .chip input {
      border: none;
      background: transparent;
      font: inherit;
      font-size: 14px;
      color: var(--text);
      outline: none;
      width: 100px;
      padding: 0;
    }
    .chip-remove {
      border: none;
      background: transparent;
      cursor: pointer;
      color: var(--muted);
      font-size: 16px;
      padding: 2px 4px;
      border-radius: 6px;
      line-height: 1;
    }
    .chip-remove:hover {
      color: var(--bad);
      background: rgba(190,77,58,0.08);
    }
    .chip-add {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      border-radius: var(--radius-sm);
      border: 1.5px dashed rgba(45,35,25,0.2);
      background: transparent;
      cursor: pointer;
      font: inherit;
      font-size: 14px;
      color: var(--muted);
      transition: all 0.15s;
    }
    .chip-add:hover {
      border-color: var(--accent);
      color: var(--accent);
    }
    .btn-primary {
      display: block;
      width: 100%;
      padding: 14px 32px;
      border-radius: var(--radius-sm);
      border: none;
      background: var(--accent);
      color: #fff;
      font-family: 'Fraunces', serif;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.15s, transform 0.15s;
      margin-top: 8px;
    }
    .btn-primary:hover {
      opacity: 0.9;
    }
    .btn-primary:active {
      transform: translateY(1px);
    }
    .btn-primary:disabled {
      opacity: 0.4;
      cursor: not-allowed;
      transform: none;
    }
    .btn-primary:focus-visible {
      outline: 2px dashed var(--accent);
      outline-offset: 3px;
    }

    /* ===== CARD FLOW SCREEN ===== */
    .card-flow {
      max-width: 780px;
      margin: 0 auto;
      padding: 24px 0;
    }
    .progress-strip {
      display: flex;
      gap: 10px;
      justify-content: center;
      align-items: center;
      margin-bottom: 28px;
      flex-wrap: wrap;
    }
    .progress-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      border: 2px solid rgba(45,35,25,0.2);
      background: transparent;
      cursor: pointer;
      transition: all 0.15s;
      padding: 0;
    }
    .progress-dot.completed {
      background: var(--accent);
      border-color: var(--accent);
    }
    .progress-dot.current {
      background: var(--accent);
      border-color: var(--accent);
      box-shadow: 0 0 0 4px rgba(196,89,58,0.2);
      animation: dotPulse 2s ease-in-out infinite;
    }
    @keyframes dotPulse {
      0%, 100% { box-shadow: 0 0 0 4px rgba(196,89,58,0.2); }
      50% { box-shadow: 0 0 0 6px rgba(196,89,58,0.12); }
    }
    .progress-counter {
      margin-left: 12px;
      font-size: 14px;
      color: var(--muted);
    }
    .indicator-card {
      background: var(--card);
      box-shadow: var(--card-shadow);
      border-radius: var(--radius);
      padding: 40px;
    }
    .indicator-title {
      font-family: 'Fraunces', serif;
      font-size: 30px;
      text-align: center;
      margin-bottom: 20px;
    }
    .indicator-descriptions {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-bottom: 32px;
    }
    .desc-col {
      padding: 16px;
      border-radius: var(--radius-sm);
    }
    .desc-col.desc-ok {
      background: rgba(90,138,88,0.08);
    }
    .desc-col.desc-bad {
      background: rgba(190,77,58,0.08);
    }
    .desc-label {
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 6px;
    }
    .desc-label.label-ok {
      color: var(--ok);
    }
    .desc-label.label-bad {
      color: var(--bad);
    }
    .desc-text {
      font-size: 14px;
      line-height: 1.5;
      color: var(--text);
    }
    .participant-rows {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .participant-row {
      display: grid;
      grid-template-columns: 130px auto auto 1fr;
      gap: 14px;
      align-items: center;
      padding: 10px 14px;
      border-radius: var(--radius-sm);
      background: rgba(45,35,25,0.02);
      transition: background 0.15s;
    }
    .participant-row:hover {
      background: rgba(45,35,25,0.04);
    }
    .participant-row:focus-within {
      box-shadow: inset 3px 0 0 var(--accent);
    }
    .p-name {
      font-size: 15px;
      font-weight: 500;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .status-buttons {
      display: flex;
      gap: 8px;
    }
    .status-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s ease-out;
      position: relative;
      box-shadow: inset 0 2px 4px rgba(45,35,25,0.1);
    }
    .status-btn .dot-inner {
      width: 12px;
      height: 12px;
      border-radius: 50%;
    }
    .status-btn.s-ok {
      background: rgba(90,138,88,0.15);
    }
    .status-btn.s-ok .dot-inner {
      background: var(--ok);
    }
    .status-btn.s-warn {
      background: rgba(201,150,58,0.15);
    }
    .status-btn.s-warn .dot-inner {
      background: var(--warn);
    }
    .status-btn.s-bad {
      background: rgba(190,77,58,0.15);
    }
    .status-btn.s-bad .dot-inner {
      background: var(--bad);
    }
    .status-btn.selected {
      transform: scale(1.1);
      box-shadow: none;
    }
    .status-btn.s-ok.selected {
      box-shadow: 0 4px 12px rgba(90,138,88,0.3);
    }
    .status-btn.s-warn.selected {
      box-shadow: 0 4px 12px rgba(201,150,58,0.3);
    }
    .status-btn.s-bad.selected {
      box-shadow: 0 4px 12px rgba(190,77,58,0.3);
    }
    .has-selection .status-btn:not(.selected) {
      opacity: 0.3;
    }
    .trend-buttons {
      display: flex;
      gap: 6px;
    }
    .trend-btn {
      width: 34px;
      height: 34px;
      border-radius: 50%;
      border: 1.5px solid rgba(45,35,25,0.12);
      background: transparent;
      font-size: 15px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s ease-out;
      color: var(--muted);
    }
    .trend-btn.selected {
      border-color: var(--accent);
      color: var(--accent);
      background: rgba(196,89,58,0.06);
    }
    .has-selection .trend-btn:not(.selected) {
      opacity: 0.3;
    }
    .note-input {
      border: none;
      border-bottom: 1.5px solid rgba(45,35,25,0.12);
      background: transparent;
      padding: 8px 0;
      font: inherit;
      font-size: 14px;
      color: var(--text);
      width: 100%;
      outline: none;
      transition: border-color 0.15s;
    }
    .note-input:focus {
      border-bottom-color: var(--accent);
    }
    .note-input::placeholder {
      color: var(--muted);
    }
    .card-nav {
      display: flex;
      justify-content: space-between;
      margin-top: 28px;
    }
    .btn-nav {
      padding: 12px 24px;
      border-radius: var(--radius-sm);
      border: 1.5px solid rgba(45,35,25,0.12);
      background: transparent;
      font: inherit;
      font-size: 15px;
      cursor: pointer;
      color: var(--text);
      transition: all 0.15s;
    }
    .btn-nav:hover {
      border-color: rgba(45,35,25,0.25);
    }
    .btn-nav:focus-visible {
      outline: 2px dashed var(--accent);
      outline-offset: 3px;
    }
    .btn-nav-primary.ready {
      background: var(--accent);
      color: #fff;
      border-color: var(--accent);
    }
    .btn-nav-primary.ready:hover {
      opacity: 0.9;
    }

    /* ===== RESULTS SCREEN ===== */
    .results-wrap {
      max-width: 780px;
      margin: 0 auto;
      padding: 24px 0;
    }
    .results-title {
      font-size: 28px;
      text-align: center;
      margin-bottom: 24px;
    }
    .results-body {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-bottom: 24px;
    }
    .result-row {
      display: grid;
      grid-template-columns: 160px 1fr 1fr;
      gap: 16px;
      padding: 12px 16px;
      border-radius: var(--radius-sm);
      background: var(--card);
      box-shadow: var(--card-shadow);
      align-items: center;
      cursor: pointer;
      transition: transform 0.15s;
    }
    .result-row:hover {
      transform: translateY(-1px);
    }
    .result-indicator {
      font-weight: 600;
      font-size: 14px;
    }
    .result-dots {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }
    .result-dot {
      width: 14px;
      height: 14px;
      border-radius: 50%;
    }
    .result-dot.r-ok {
      background: var(--ok);
    }
    .result-dot.r-warn {
      background: var(--warn);
    }
    .result-dot.r-bad {
      background: var(--bad);
    }
    .result-dot.r-empty {
      background: rgba(45,35,25,0.1);
    }
    .result-trends {
      display: flex;
      gap: 6px;
      font-size: 15px;
      color: var(--muted);
    }
    .results-notes {
      margin-bottom: 24px;
    }
    .results-notes label {
      display: block;
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 6px;
    }
    .results-notes textarea {
      width: 100%;
      border: 1.5px solid rgba(45,35,25,0.12);
      border-radius: var(--radius-sm);
      padding: 12px;
      font: inherit;
      color: var(--text);
      background: transparent;
      outline: none;
      resize: vertical;
      min-height: 80px;
    }
    .results-notes textarea:focus {
      border-color: var(--accent);
    }
    .results-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .results-right {
      display: flex;
      gap: 8px;
    }

    /* ===== COMPARE SCREEN ===== */
    .compare-wrap {
      max-width: 960px;
      margin: 0 auto;
      padding: 24px 0;
    }
    .dropzone {
      border: 2px dashed rgba(45,35,25,0.2);
      border-radius: var(--radius);
      padding: 40px;
      text-align: center;
      cursor: pointer;
      transition: all 0.15s;
      display: block;
    }
    .dropzone:hover, .dropzone.dragover {
      border-color: var(--accent);
      background: rgba(196,89,58,0.03);
    }
    .dropzone strong {
      display: block;
      font-family: 'Fraunces', serif;
      font-size: 18px;
      margin-bottom: 6px;
    }
    .drop-hint {
      font-size: 13px;
      color: var(--muted);
    }
    .compare-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin: 16px 0;
    }
    .compare-table-wrap {
      overflow-x: auto;
      border-radius: var(--radius);
    }
    #compareTable {
      border-spacing: 6px;
      border-collapse: separate;
      width: 100%;
    }
    #compareTable th, #compareTable td {
      padding: 10px 14px;
      border-radius: var(--radius-sm);
      font-size: 14px;
    }
    #compareTable thead th {
      background: var(--card);
      box-shadow: var(--card-shadow);
      font-weight: 600;
    }
    #compareTable tbody th {
      background: var(--card);
      box-shadow: var(--card-shadow);
      text-align: left;
      font-weight: 600;
    }
    #compareTable tbody td {
      background: var(--card);
      box-shadow: var(--card-shadow);
      text-align: center;
    }
    #compareTable tbody tr:hover td {
      background: rgba(250,246,241,0.9);
    }
    .sumCell {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .sumDot {
      width: 14px;
      height: 14px;
      border-radius: 50%;
    }
    .sumDot.ok {
      background: var(--ok);
    }
    .sumDot.warn {
      background: var(--warn);
    }
    .sumDot.bad {
      background: var(--bad);
    }
    .sumTrend {
      font-weight: 700;
      font-size: 14px;
    }

    /* ===== AUTOSAVE STATUS ===== */
    .autosave-status {
      position: fixed;
      bottom: 12px;
      right: 16px;
      font-size: 12px;
      color: var(--muted);
      transition: opacity 0.3s;
      opacity: 0;
    }

    /* ===== REDUCED MOTION ===== */
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
        scroll-behavior: auto !important;
      }
    }
  </style>
</head>
<body>
  <a class="skip" id="skipLink" href="#main">Skip to content</a>

  <header>
    <div class="row">
      <h1 id="appTitle">Team Health Check</h1>
      <div class="modeToggle" role="group" aria-label="Mode">
        <button id="modeSession" class="modeBtn" type="button" aria-pressed="true">Run Session</button>
        <button id="modeCompare" class="modeBtn" type="button" aria-pressed="false">Compare Teams</button>
      </div>
      <div class="langToggle" role="group" aria-label="Language">
        <button id="langEn" class="langBtn" type="button" aria-pressed="true">EN</button>
        <button id="langRu" class="langBtn" type="button" aria-pressed="false">RU</button>
      </div>
    </div>
  </header>

  <main id="main">
    <div class="wrap">
      <div id="setupScreen" class="screen active">
        <div class="setup-card">
          <h2 id="setupTitle">Session Setup</h2>
          <div class="setup-fields">
            <div class="field">
              <label for="teamName" id="labelTeam">Team</label>
              <input id="teamName" type="text" autocomplete="organization" />
            </div>
            <div class="field">
              <label for="checkDate" id="labelDate">Date</label>
              <input id="checkDate" type="date" />
            </div>
            <div class="field">
              <label for="facilitator" id="labelFac">Facilitator</label>
              <input id="facilitator" type="text" autocomplete="name" />
            </div>
          </div>
          <div class="participants-section">
            <h3 id="participantsTitle">Participants</h3>
            <div id="participantChips" class="chip-row"></div>
          </div>
          <button id="btnStart" class="btn-primary" type="button" disabled>Start Session</button>
        </div>
      </div>
      <div id="cardScreen" class="screen">
        <div class="card-flow">
          <div class="progress-strip" id="progressStrip"></div>
          <div class="indicator-card" id="indicatorCard"></div>
          <div class="card-nav">
            <button id="btnPrev" class="btn-nav" type="button"></button>
            <button id="btnNext" class="btn-nav btn-nav-primary" type="button"></button>
          </div>
        </div>
      </div>
      <div id="resultsScreen" class="screen">
        <div class="results-wrap">
          <h2 class="results-title" id="resultsTitle">Results</h2>
          <div id="resultsBody" class="results-body"></div>
          <div class="results-notes">
            <label for="overallNotes" id="labelOverallNotes">Overall notes</label>
            <textarea id="overallNotes" rows="3"></textarea>
          </div>
          <div class="results-actions">
            <button id="btnBackReview" class="btn-nav" type="button"></button>
            <div class="results-right">
              <button id="btnResetSession" class="btn-nav" type="button"></button>
              <button id="btnExportCsv" class="btn-nav btn-nav-primary ready" type="button"></button>
            </div>
          </div>
        </div>
      </div>
      <div id="compareScreen" class="screen">
        <div class="compare-wrap">
          <div id="compareFileChips" class="chip-row" style="margin-bottom:12px;"></div>
          <input id="multiFiles" type="file" accept=".csv,text/csv" multiple hidden />
          <label id="multiDrop" class="dropzone" for="multiFiles">
            <div>
              <strong id="dropTitle">Drop CSV files here</strong>
              <div class="drop-hint" id="dropHint">or click to select multiple team healthcheck CSV files</div>
            </div>
          </label>
          <div id="compareActions" class="compare-actions" style="display:none;">
            <button id="btnClearCompare" class="btn-nav" type="button">Clear</button>
            <button id="btnExportCompare" class="btn-nav btn-nav-primary ready" type="button">Export summary CSV</button>
          </div>
          <div id="compareTableWrap" class="compare-table-wrap" style="display:none;">
            <table id="compareTable">
              <thead id="compareHead"></thead>
              <tbody id="compareBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </main>

  <footer>
    <div class="wrap">
      <div class="row">
        <div id="footerLeft">
          Based on Spotify Engineering:
          <a id="spotifyLink" href="https://engineering.atspotify.com/2014/09/squad-health-check-model" target="_blank" rel="noopener noreferrer">Squad Health Check model</a>.
          <div id="telegramCredit" style="margin-top:6px;"></div>
        </div>
        <div>
          <a id="otherProjectsLink" href="index.html">View other projects</a>
        </div>
      </div>
    </div>
  </footer>

  <div id="autosaveStatus" class="autosave-status"></div>

  <script>
    (() => {
      // ===== CONSTANTS =====
      const LANG_KEY = 'teamHealthCheck_lang_v1';
      const STORAGE_KEY = 'teamHealthCheck_v2';
      const OLD_STORAGE_KEY = 'teamHealthCheck_matrix_v1';
      const LEGACY_STORAGE_KEY = 'teamHealthCheck_v1';

      // ===== I18N DICTIONARY =====
      const I18N = {
        ru: {
          langLabel: 'Язык',
          tabsChecklist: 'Чек-лист',
          tabsSummary: 'Сводка по файлам',
          tourBtn: 'Как пользоваться?',
          pageTitle: 'Team Health Check — экспорт CSV',
          sessionTitle: 'Сессия',
          exportCsv: 'Скачать CSV',
          reset: 'Сбросить',
          resetConfirm: 'Сбросить форму и локально сохранённое состояние?',
          resetDone: 'Сброшено',
          teamLabel: 'Команда',
          dateLabel: 'Дата',
          facilitatorLabel: 'Фасилитатор / Автор',
          summaryPanelAria: 'Сводка по нескольким командам',
          clear: 'Очистить',
          exportSummary: 'Скачать CSV (сводка)',
          dropTitle: 'Перетащи CSV-файлы сюда',
          dropHint: 'или нажми, чтобы выбрать несколько файлов хелсчеков команд',
          summaryTableAria: 'Сводная таблица по файлам',
          checklistPanelAria: 'Матрица Health Check',
          checklistRegionAria: 'Матрица Team Health Check',
          checklistTitle: 'Squad Health Checklist',
          participant: 'Участник',
          participantsHeading: 'Участники',
          participantName: 'Имя',
          participantNameLabel: 'Имя участника',
          removeParticipant: 'Удалить участника',
          addParticipant: 'Добавить участника',
          statusAria: 'статус',
          trendAria: 'тренд',
          trendNone: '—',
          trendUp: '↗ Улучшается',
          trendStable: '→ Стабильно',
          trendDown: '↘ Ухудшается',
          note: 'Заметка',
          green: 'Зелёный',
          yellow: 'Жёлтый',
          red: 'Красный',
          greenPrefix: 'Зеленый',
          redPrefix: 'Красный',
          autosaveSaving: 'Сохранение...',
          autosaveSavedAt: (t) => `Сохранено локально в ${t}`,
          autosaveFailed: 'Не удалось сохранить в localStorage',
          loaded: 'Загружено из localStorage',
          exportMissing: (n) => `Не заполнено состояние (зел/жёлт/красн) для ${n} индикаторов.\n\nПродолжить экспорт?`,
          deleteColConfirm: 'Удалить колонку? Данные в ней будут потеряны.',
          cantDeleteLast: 'Нельзя удалить последнюю колонку.',
          otherProjects: 'Посмотреть другие проекты',
          footerLeft: 'Модель сделана на основе Spotify Engineering:',
          telegramCreditHtml: 'Сделано для канала <a href="https://t.me/dimasshortposts" target="_blank" rel="noopener noreferrer">@dimasshortposts</a>',
          // New keys for redesign
          'setup.title': 'Настройка сессии',
          'setup.startSession': 'Начать сессию',
          'setup.addParticipant': 'Добавить',
          'setup.resumePrompt': 'Продолжить предыдущую сессию?',
          'setup.resumeYes': 'Продолжить',
          'setup.resumeNo': 'Начать заново',
          'card.healthy': 'Здорово',
          'card.unhealthy': 'Плохо',
          'card.prev': 'Назад',
          'card.next': 'Далее',
          'card.finish': 'Завершить',
          'card.notePlaceholder': 'Добавить заметку...',
          'results.title': 'Результаты',
          'results.overallNotes': 'Общие заметки',
          'results.overallNotesPlaceholder': 'Заметки фасилитатора...',
          'results.backToReview': 'Вернуться к обзору',
          'results.exportCsv': 'Скачать CSV',
          'mode.session': 'Сессия',
          'mode.compare': 'Сравнение команд',
          tour: {
            prev: 'Назад',
            next: 'Далее',
            done: 'Готово',
            step: (i, n) => `Шаг ${i} из ${n}`,
            steps: {
              tabsTitle: 'Вкладки',
              tabsBody: 'Здесь переключайся между чек-листом и сводкой по нескольким CSV.',
              teamTitle: 'Команда',
              teamBody: 'Введи название команды. Оно попадёт в CSV и в сводку.',
              dateTitle: 'Дата',
              dateBody: 'Выбери дату сессии. Удобно сравнивать несколько прогонов по датам.',
              facTitle: 'Фасилитатор',
              facBody: 'Укажи автора/фасилитатора (по желанию).',
              participantsTitle: 'Участники',
              participantsBody: 'Нажми плюс, чтобы добавить участника (колонку).',
              nameTitle: 'Имя участника',
              nameBody: 'Введи имя участника в заголовке его колонки.',
              cellTitle: 'Заполни ячейку',
              cellBody: 'Вместе с каждым участником команды выберите цвет и тренд по всем 10 пунктам.',
              exportTitle: 'Экспорт CSV',
              exportBody: 'Когда команда заполнит форму, скачай CSV.',
              summaryTitle: 'Сводка по файлам',
              summaryBody: 'Перейдём в сводку, чтобы сравнить несколько CSV между командами/датами.',
              dropTitle: 'Загрузка CSV',
              dropBody: 'Перетащи сюда несколько заполненных CSV команд (можно пачкой) или нажми и выбери файлы.'
            }
          }
        },
        en: {
          langLabel: 'Language',
          tabsChecklist: 'Checklist',
          tabsSummary: 'Multi-file summary',
          tourBtn: 'How to use?',
          pageTitle: 'Team Health Check — CSV export',
          sessionTitle: 'Session',
          exportCsv: 'Download CSV',
          reset: 'Reset',
          resetConfirm: 'Reset the form and locally saved state?',
          resetDone: 'Reset',
          teamLabel: 'Team',
          dateLabel: 'Date',
          facilitatorLabel: 'Facilitator / Author',
          summaryPanelAria: 'Multi-team summary',
          clear: 'Clear',
          exportSummary: 'Download CSV (summary)',
          dropTitle: 'Drop CSV files here',
          dropHint: 'or click to select multiple team healthcheck CSV files',
          summaryTableAria: 'Multi-file summary table',
          checklistPanelAria: 'Health Check matrix',
          checklistRegionAria: 'Team Health Check matrix',
          checklistTitle: 'Squad Health Checklist',
          participant: 'Participant',
          participantsHeading: 'Participants',
          participantName: 'Name',
          participantNameLabel: 'Participant name',
          removeParticipant: 'Remove participant',
          addParticipant: 'Add participant',
          statusAria: 'status',
          trendAria: 'trend',
          trendNone: '—',
          trendUp: '↗ Improving',
          trendStable: '→ Stable',
          trendDown: '↘ Worsening',
          note: 'Note',
          green: 'Green',
          yellow: 'Yellow',
          red: 'Red',
          greenPrefix: 'Green',
          redPrefix: 'Red',
          autosaveSaving: 'Saving…',
          autosaveSavedAt: (t) => `Saved locally at ${t}`,
          autosaveFailed: 'Failed to save to localStorage',
          loaded: 'Loaded from localStorage',
          exportMissing: (n) => `Some cells have no status selected for ${n} criteria.\n\nExport anyway?`,
          deleteColConfirm: 'Delete this participant column? Data will be lost.',
          cantDeleteLast: 'You cannot delete the last column.',
          otherProjects: 'View other projects',
          footerLeft: 'Based on Spotify Engineering:',
          telegramCreditHtml: 'Made for the channel <a href="https://t.me/dimasshortposts" target="_blank" rel="noopener noreferrer">@dimasshortposts</a>',
          // New keys for redesign
          'setup.title': 'Session Setup',
          'setup.startSession': 'Start Session',
          'setup.addParticipant': 'Add',
          'setup.resumePrompt': 'Resume previous session?',
          'setup.resumeYes': 'Resume',
          'setup.resumeNo': 'Start fresh',
          'card.healthy': 'Healthy',
          'card.unhealthy': 'Unhealthy',
          'card.prev': 'Previous',
          'card.next': 'Next',
          'card.finish': 'Finish',
          'card.notePlaceholder': 'Add a note...',
          'results.title': 'Results',
          'results.overallNotes': 'Overall notes',
          'results.overallNotesPlaceholder': 'Facilitator notes...',
          'results.backToReview': 'Back to review',
          'results.exportCsv': 'Export CSV',
          'mode.session': 'Run Session',
          'mode.compare': 'Compare Teams',
          tour: {
            prev: 'Back',
            next: 'Next',
            done: 'Done',
            step: (i, n) => `Step ${i} of ${n}`,
            steps: {
              tabsTitle: 'Tabs',
              tabsBody: 'Switch between the checklist and the multi-file CSV summary here.',
              teamTitle: 'Team',
              teamBody: 'Enter the team name. It will be included in CSV and the summary.',
              dateTitle: 'Date',
              dateBody: 'Choose the session date to compare multiple runs over time.',
              facTitle: 'Facilitator',
              facBody: 'Optionally enter the facilitator/author.',
              participantsTitle: 'Participants',
              participantsBody: 'Click plus to add a participant (a column).',
              nameTitle: 'Participant name',
              nameBody: 'Enter the participant name in the column header.',
              cellTitle: 'Fill a cell',
              cellBody: 'Together with each team member, choose a color and a trend for all 10 items.',
              exportTitle: 'Export CSV',
              exportBody: 'When the team finishes the form, download the CSV.',
              summaryTitle: 'Multi-file summary',
              summaryBody: 'Switch to summary to compare multiple CSVs across teams/dates.',
              dropTitle: 'Upload CSV',
              dropBody: 'Drop multiple completed team CSV files here (batch is ok) or click to select files.'
            }
          }
        }
      };

      // ===== LANGUAGE FUNCTIONS =====
      function getLang() {
        try {
          const url = new URL(window.location.href);
          const fromUrl = url.searchParams.get('lang');
          if (fromUrl === 'en' || fromUrl === 'ru') return fromUrl;
        } catch(_) {}
        try {
          const saved = localStorage.getItem(LANG_KEY);
          if (saved === 'en' || saved === 'ru') return saved;
        } catch(_) {}
        return 'en';
      }

      let lang = getLang();

      function t(key) {
        const dict = I18N[lang] || I18N.ru;
        // Support dot notation for nested keys like 'tour.prev'
        // First try direct property (for keys like 'setup.title' stored as string keys)
        if (Object.prototype.hasOwnProperty.call(dict, key)) return dict[key];
        // Then try dot-path traversal (for nested objects like tour.prev)
        const parts = String(key).split('.');
        let cur = dict;
        for (const p of parts) {
          if (!cur || typeof cur !== 'object') return '';
          cur = cur[p];
        }
        return cur;
      }

      function setLang(next) {
        lang = next === 'en' ? 'en' : 'ru';
        try { localStorage.setItem(LANG_KEY, lang); } catch(_) {}

        try {
          const url = new URL(window.location.href);
          url.searchParams.set('lang', lang);
          window.history.replaceState({}, '', url);
        } catch(_) {}

        document.documentElement.lang = lang;

        const langRuBtn = document.getElementById('langRu');
        const langEnBtn = document.getElementById('langEn');
        if (langRuBtn) langRuBtn.setAttribute('aria-pressed', lang === 'ru' ? 'true' : 'false');
        if (langEnBtn) langEnBtn.setAttribute('aria-pressed', lang === 'en' ? 'true' : 'false');

        // Update mode toggle labels
        const modeSession = document.getElementById('modeSession');
        const modeCompare = document.getElementById('modeCompare');
        if (modeSession) modeSession.textContent = t('mode.session');
        if (modeCompare) modeCompare.textContent = t('mode.compare');

        // Update footer
        const footerLeft = document.getElementById('footerLeft');
        if (footerLeft) footerLeft.firstChild.nodeValue = `${t('footerLeft')} `;
        const telegramCredit = document.getElementById('telegramCredit');
        if (telegramCredit) telegramCredit.innerHTML = t('telegramCreditHtml');
        const otherProjectsLink = document.getElementById('otherProjectsLink');
        if (otherProjectsLink) otherProjectsLink.textContent = t('otherProjects');
      }

      function indTitle(ind) { return lang === 'en' ? (ind.titleEn || ind.title) : ind.title; }
      function indShort(ind) { return lang === 'en' ? (ind.shortEn || ind.short || indTitle(ind)) : (ind.short || indTitle(ind)); }
      function indAwesome(ind) { return lang === 'en' ? (ind.awesomeEn || ind.awesome) : ind.awesome; }
      function indCrappy(ind) { return lang === 'en' ? (ind.crappyEn || ind.crappy) : ind.crappy; }

      // ===== INDICATORS =====
      const indicators = [
        {
          id: 'value',
          title: 'Ценность',
          short: 'Ценность',
          awesome: 'Мы делаем именно то, что приносит пользу нашим клиентам и бизнесу.',
          crappy: 'Мы делаем работу, которая не несет никакой ценности или смысла.',
          titleEn: 'Value',
          shortEn: 'Value',
          awesomeEn: 'We build what brings value to our customers and the business.',
          crappyEn: 'We do work that brings no value or meaning.'
        },
        {
          id: 'easy_to_release',
          title: 'Простота релиза',
          short: 'Релиз',
          awesome: 'Релизы простые, частые и безболезненные, полностью автоматизированные.',
          crappy: 'Релизы — это ручной, болезненный процесс, который часто сопровождается проблемами.',
          titleEn: 'Easy to Release',
          shortEn: 'Release',
          awesomeEn: 'Releases are simple, frequent, painless and fully automated.',
          crappyEn: 'Releases are manual, painful and often come with problems.'
        },
        {
          id: 'fun',
          title: 'Веселье',
          short: 'Веселье',
          awesome: 'Мы с удовольствием приходим на работу и отлично проводим время.',
          crappy: 'Ужасная скука.',
          titleEn: 'Fun',
          shortEn: 'Fun',
          awesomeEn: 'We enjoy coming to work and have a great time.',
          crappyEn: 'Terribly boring.'
        },
        {
          id: 'tech_quality',
          title: 'Состояние кода',
          short: 'Код',
          awesome: 'Мы гордимся качеством нашего кода. Он чистый, понятный и легко тестируемый.',
          crappy: 'Код — это полная катастрофа, технический долг зашкаливает.',
          titleEn: 'Health of Codebase',
          shortEn: 'Code',
          awesomeEn: 'We are proud of our code quality. It is clean, clear and easy to test.',
          crappyEn: 'The codebase is a mess and technical debt is out of control.'
        },
        {
          id: 'learning',
          title: 'Обучение',
          short: 'Обучение',
          awesome: 'Мы постоянно учимся новому и интересному.',
          crappy: 'У нас нет времени или возможности учиться чему-то новому.',
          titleEn: 'Learning',
          shortEn: 'Learning',
          awesomeEn: 'We keep learning new and interesting things.',
          crappyEn: 'We have no time or opportunity to learn.'
        },
        {
          id: 'speed',
          title: 'Скорость',
          short: 'Скорость',
          awesome: 'Мы доставляем ценность быстро и вовремя.',
          crappy: 'Нам всегда не хватает времени. Процессы медленные и затянутые.',
          titleEn: 'Speed',
          shortEn: 'Speed',
          awesomeEn: 'We deliver value quickly and on time.',
          crappyEn: 'We are always short on time. Processes are slow and dragged out.'
        },
        {
          id: 'suitable_process',
          title: 'Подходящий процесс',
          short: 'Процесс',
          awesome: 'Процесс работы нам отлично подходит и помогает.',
          crappy: 'Процесс мешает работе или вообще отсутствует.',
          titleEn: 'Suitable Process',
          shortEn: 'Process',
          awesomeEn: 'Our process fits us well and helps us.',
          crappyEn: 'The process gets in the way or does not exist.'
        },
        {
          id: 'support',
          title: 'Поддержка',
          short: 'Поддержка',
          awesome: 'Мы всегда получаем отличную поддержку, когда она нам необходима.',
          crappy: 'Мы чувствуем себя брошенными на произвол судьбы.',
          titleEn: 'Support',
          shortEn: 'Support',
          awesomeEn: 'We get great support whenever we need it.',
          crappyEn: 'We feel left on our own.'
        },
        {
          id: 'pawns_or_players',
          title: 'Командная работа',
          short: 'Команда',
          awesome: 'Мы работаем как сплоченная команда и всегда помогаем друг другу.',
          crappy: 'Мы работаем как группа отдельных людей, а не как единое целое.',
          titleEn: 'Teamwork',
          shortEn: 'Team',
          awesomeEn: 'We work as a cohesive team and help each other.',
          crappyEn: 'We act as separate individuals, not as one team.'
        },
        {
          id: 'mission',
          title: 'Миссия',
          short: 'Миссия',
          awesome: 'Мы четко понимаем, зачем мы здесь и куда движемся.',
          crappy: 'У нас нет ясного понимания целей и общего видения будущего',
          titleEn: 'Mission',
          shortEn: 'Mission',
          awesomeEn: 'We clearly understand why we are here and where we are going.',
          crappyEn: 'We lack clear goals and a shared vision of the future.'
        }
      ];

      // ===== INDICATOR NAME LOOKUP =====
      const indicatorNameToId = (() => {
        const m = new Map();
        for (const ind of indicators) {
          const all = [
            ind.title,
            ind.short,
            ind.titleEn,
            ind.shortEn
          ].filter(Boolean);
          for (const v of all) {
            m.set(String(v).trim().toLowerCase(), ind.id);
          }
        }
        return m;
      })();

      function normalizeIndicatorToId(v) {
        const key = String(v || '').trim().toLowerCase();
        return indicatorNameToId.get(key) || null;
      }

      // ===== UTILITY FUNCTIONS =====
      function uid() {
        const rnd = Math.random().toString(16).slice(2);
        return `c_${Date.now().toString(16)}_${rnd}`;
      }

      function escapeCsvCell(v) {
        const s = v == null ? '' : String(v);
        if (/[",\n\r]/.test(s)) return `"${s.replaceAll('"', '""')}"`;
        return s;
      }

      function buildFilename(meta) {
        const date = meta.date || todayISO();
        const team = (meta.team || 'team').trim().replaceAll(/\s+/g, '_').replaceAll(/[^a-zA-Z0-9_\-а-яА-Я]/g, '');
        return `team-health-check_${team || 'team'}_${date}.csv`;
      }

      function todayISO() {
        const d = new Date();
        return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
      }

      function pad2(n) {
        const s = String(n);
        return s.length >= 2 ? s : `0${s}`;
      }

      function parseCsv(text) {
        const rows = [];
        let row = [];
        let cur = '';
        let inQ = false;
        for (let i = 0; i < text.length; i++) {
          const ch = text[i];
          if (inQ) {
            if (ch === '"') {
              const next = text[i+1];
              if (next === '"') {
                cur += '"';
                i++;
              } else {
                inQ = false;
              }
            } else {
              cur += ch;
            }
            continue;
          }

          if (ch === '"') {
            inQ = true;
            continue;
          }
          if (ch === ',') {
            row.push(cur);
            cur = '';
            continue;
          }
          if (ch === '\n') {
            row.push(cur);
            cur = '';
            if (row.length > 1 || row.some((v) => v.trim() !== '')) rows.push(row);
            row = [];
            continue;
          }
          if (ch === '\r') continue;
          cur += ch;
        }
        row.push(cur);
        if (row.length > 1 || row.some((v) => v.trim() !== '')) rows.push(row);
        return rows;
      }

      function normalizeHeader(h) {
        return String(h || '').trim().toLowerCase();
      }

      function rowsToObjects(rows) {
        if (!rows || rows.length < 2) return [];
        const header = rows[0].map(normalizeHeader);
        const out = [];
        for (let i = 1; i < rows.length; i++) {
          const r = rows[i];
          const o = {};
          for (let j = 0; j < header.length; j++) {
            o[header[j]] = (r[j] == null) ? '' : String(r[j]);
          }
          out.push(o);
        }
        return out;
      }

      // ===== STATE =====
      let currentScreen = 'setup';
      let currentCardIndex = 0;

      let state = {
        global: { team: '', date: todayISO(), facilitator: '', overallNotes: '' },
        columns: [],
        data: {}
      };

      function blankColumn() {
        const id = uid();
        return {
          id,
          name: ''
        };
      }

      function ensureStateShape() {
        if (!state || typeof state !== 'object') state = { global: { team: '', date: todayISO(), facilitator: '', overallNotes: '' }, columns: [], data: {} };
        if (!state.global || typeof state.global !== 'object') state.global = { team: '', date: todayISO(), facilitator: '', overallNotes: '' };
        if (!Array.isArray(state.columns)) state.columns = [];
        if (!state.data || typeof state.data !== 'object') state.data = {};

        if (!state.columns.length) {
          state.columns = [blankColumn()];
        }
        for (const ind of indicators) {
          if (!state.data[ind.id] || typeof state.data[ind.id] !== 'object') state.data[ind.id] = {};
          for (const col of state.columns) {
            if (!state.data[ind.id][col.id] || typeof state.data[ind.id][col.id] !== 'object') {
              state.data[ind.id][col.id] = { status: '', trend: '', note: '' };
            }
          }
        }
      }

      function serialize() {
        return {
          global: state.global,
          columns: state.columns,
          data: state.data
        };
      }

      function applyState(saved) {
        const s = saved && typeof saved === 'object' ? saved : null;
        state = {
          global: (s && s.global && typeof s.global === 'object') ? s.global : { team: '', date: todayISO(), facilitator: '', overallNotes: '' },
          columns: (s && Array.isArray(s.columns)) ? s.columns : [],
          data: (s && s.data && typeof s.data === 'object') ? s.data : {}
        };
        ensureStateShape();
      }

      // ===== AUTOSAVE =====
      let autosaveTimer = null;

      function scheduleAutosave() {
        if (autosaveTimer) window.clearTimeout(autosaveTimer);
        autosaveTimer = window.setTimeout(() => {
          try {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(serialize()));
          } catch(_) {}
        }, 250);
      }

      // ===== CSV EXPORT =====
      function validateForExport() {
        const invalid = [];
        for (const ind of indicators) {
          for (const col of state.columns) {
            const cellData = (state.data[ind.id] && state.data[ind.id][col.id]) ? state.data[ind.id][col.id] : {};
            if (!cellData.status) invalid.push(`${indTitle(ind)} / ${col.name || t('participant')}`);
          }
        }
        return invalid;
      }

      function exportCsv() {
        const global = state.global;
        const missing = validateForExport();

        if (missing.length) {
          const msg = t('exportMissing');
          const msgText = typeof msg === 'function' ? msg(missing.length) : '';
          if (!window.confirm(msgText)) return;
        }

        const header = ['participant_id','participant_name','team','date','facilitator','indicator','status','trend','note','overall_notes'];
        const rows = [header];

        for (const ind of indicators) {
          for (const col of state.columns) {
            const cellData = (state.data[ind.id] && state.data[ind.id][col.id]) ? state.data[ind.id][col.id] : {};
            rows.push([
              col.id,
              col.name || '',
              global.team || '',
              global.date || '',
              global.facilitator || '',
              indTitle(ind),
              cellData.status || '',
              cellData.trend || '',
              cellData.note || '',
              global.overallNotes || ''
            ]);
          }
        }

        const csv = rows.map((r) => r.map(escapeCsvCell).join(',')).join('\n');
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = buildFilename({ team: global.team || 'team', date: global.date || todayISO() });
        a.className = 'sr';
        a.textContent = 'download';
        document.body.appendChild(a);
        a.click();
        a.remove();
        window.setTimeout(() => URL.revokeObjectURL(url), 0);
      }

      // ===== MIGRATIONS =====
      function migrateLegacyIfNeeded() {
        let hasNew = false;
        try { hasNew = !!localStorage.getItem(OLD_STORAGE_KEY); } catch(_) { hasNew = false; }
        if (hasNew) return;

        let legacyRaw = null;
        try { legacyRaw = localStorage.getItem(LEGACY_STORAGE_KEY); } catch(_) { legacyRaw = null; }
        if (!legacyRaw) return;

        try {
          const legacy = JSON.parse(legacyRaw);
          const meta = legacy && legacy.meta && typeof legacy.meta === 'object' ? legacy.meta : {};
          const col = blankColumn();
          col.name = t('participant');

          const data = {};
          for (const ind of indicators) {
            const v = legacy && legacy.data && legacy.data[ind.id] ? legacy.data[ind.id] : { status: '', trend: '', note: '' };
            data[ind.id] = { [col.id]: { status: v.status || '', trend: v.trend || '', note: v.note || '' } };
          }

          const migrated = {
            global: {
              team: typeof meta.team === 'string' ? meta.team : '',
              date: typeof meta.date === 'string' ? meta.date : todayISO(),
              facilitator: typeof meta.facilitator === 'string' ? meta.facilitator : '',
              overallNotes: typeof meta.overallNotes === 'string' ? meta.overallNotes : ''
            },
            columns: [col],
            data
          };
          try { localStorage.setItem(OLD_STORAGE_KEY, JSON.stringify(migrated)); } catch(_) {}
        } catch(_) {}
      }

      function migrateMatrixToParticipantsIfNeeded() {
        let raw = null;
        try { raw = localStorage.getItem(OLD_STORAGE_KEY); } catch(_) { raw = null; }
        if (!raw) return;

        try {
          const saved = JSON.parse(raw);
          const cols = saved && Array.isArray(saved.columns) ? saved.columns : null;
          const global = saved && saved.global && typeof saved.global === 'object' ? saved.global : null;
          const isOldMatrix = !!cols && cols.length && (Object.prototype.hasOwnProperty.call(cols[0], 'title') || Object.prototype.hasOwnProperty.call(cols[0], 'team'));
          if (!isOldMatrix) return;

          const newGlobal = {
            team: (global && typeof global.team === 'string') ? global.team : '',
            date: (global && typeof global.date === 'string') ? global.date : todayISO(),
            facilitator: (global && typeof global.facilitator === 'string') ? global.facilitator : '',
            overallNotes: (global && typeof global.overallNotes === 'string') ? global.overallNotes : ''
          };

          // Try to recover team/date/facilitator from the first old column
          const first = cols[0];
          if (first && typeof first === 'object') {
            if (!newGlobal.team && typeof first.team === 'string') newGlobal.team = first.team;
            if (typeof first.date === 'string') newGlobal.date = first.date;
            if (!newGlobal.facilitator && typeof first.facilitator === 'string') newGlobal.facilitator = first.facilitator;
          }

          const newCols = cols.map((c) => ({
            id: c.id,
            name: (typeof c.title === 'string' && c.title.trim()) ? c.title.trim() : (typeof c.name === 'string' ? c.name : '')
          }));

          const migrated = {
            global: newGlobal,
            columns: newCols,
            data: saved.data && typeof saved.data === 'object' ? saved.data : {}
          };
          localStorage.setItem(OLD_STORAGE_KEY, JSON.stringify(migrated));
        } catch(_) {}
      }

      // v1 -> v2 migration: copy data from old key to new key if new key doesn't exist
      function migrateV1toV2IfNeeded() {
        let hasV2 = false;
        try { hasV2 = !!localStorage.getItem(STORAGE_KEY); } catch(_) { hasV2 = false; }
        if (hasV2) return;

        let oldRaw = null;
        try { oldRaw = localStorage.getItem(OLD_STORAGE_KEY); } catch(_) { oldRaw = null; }
        if (!oldRaw) return;

        try {
          localStorage.setItem(STORAGE_KEY, oldRaw);
        } catch(_) {}
      }

      // ===== MULTI-FILE SUMMARY DATA LAYER =====
      let multiAgg = new Map();

      function getMultiBucket(team, date, indicator) {
        const tm = team || '—';
        const d = date || '—';
        const i = indicator || '—';
        const key = `${tm}__${d}__${i}`;
        const prev = multiAgg.get(key) || { team: tm, date: d, indicator: i, green: 0, yellow: 0, red: 0, trendCounts: { up: 0, stable: 0, down: 0 }, responses: 0, votes: [] };
        multiAgg.set(key, prev);
        return prev;
      }

      function addParticipantExport(objects) {
        for (const o of objects) {
          const team = (o.team || '').trim() || '—';
          const date = (o.date || '').trim() || '—';
          const indicator = (o.indicator || '').trim();
          const indicatorId = normalizeIndicatorToId(indicator) || indicator;
          const status = (o.status || '').trim().toLowerCase();
          const trend = (o.trend || '').trim();
          const participantName = (o.participant_name || '').trim();
          const participantId = (o.participant_id || '').trim();
          const note = (o.note || '').trim();
          const prev = getMultiBucket(team, date, indicatorId);
          if (status === 'green') prev.green++;
          if (status === 'yellow') prev.yellow++;
          if (status === 'red') prev.red++;
          if (trend && Object.prototype.hasOwnProperty.call(prev.trendCounts, trend)) prev.trendCounts[trend]++;
          prev.responses++;
          if (Array.isArray(prev.votes)) {
            prev.votes.push({
              participantId,
              participantName,
              status,
              trend,
              note
            });
          }
        }
      }

      function addSummaryExport(objects) {
        for (const o of objects) {
          const team = (o.team || '').trim() || '—';
          const date = (o.date || '').trim() || '—';
          const indicator = (o.indicator || '').trim() || '—';
          const indicatorId = normalizeIndicatorToId(indicator) || indicator;
          const prev = getMultiBucket(team, date, indicatorId);

          const green = Number(o.green || 0) || 0;
          const yellow = Number(o.yellow || 0) || 0;
          const red = Number(o.red || 0) || 0;
          const responses = green + yellow + red;

          prev.green += green;
          prev.yellow += yellow;
          prev.red += red;
          prev.responses += responses;

          const tr = (o.trend || '').trim();
          if (tr.includes('↗')) prev.trendCounts.up++;
          if (tr.includes('→')) prev.trendCounts.stable++;
          if (tr.includes('↘')) prev.trendCounts.down++;
        }
      }

      function pickLatestDatePerTeam() {
        const m = new Map();
        for (const b of multiAgg.values()) {
          const team = b.team || '—';
          const date = b.date || '—';
          if (m.has(team)) {
            const prev = m.get(team);
            if (prev < date) m.set(team, date);
          } else {
            m.set(team, date);
          }
        }
        return m;
      }

      function getBucket(team, date, indicator) {
        const tm = (team || '—');
        const d = (date || '—');
        const i = (indicator || '—');
        return multiAgg.get(`${tm}__${d}__${i}`) || null;
      }

      function worstStatus(bucket) {
        if (!bucket) return '';
        if ((bucket.red || 0) > 0) return 'red';
        if ((bucket.yellow || 0) > 0) return 'yellow';
        if ((bucket.green || 0) > 0) return 'green';
        return '';
      }

      function worstTrendLabel(trendCounts) {
        if (!trendCounts || typeof trendCounts !== 'object') return t('trendNone');
        if ((trendCounts.down || 0) > 0) return t('trendDown');
        if ((trendCounts.stable || 0) > 0) return t('trendStable');
        if ((trendCounts.up || 0) > 0) return t('trendUp');
        return t('trendNone');
      }

      function dominantTrendLabel(trendCounts) {
        const entries = Object.entries(trendCounts);
        entries.sort((a, b) => b[1] - a[1]);
        const top = entries[0];
        if (!top || top[1] === 0) return t('trendNone');
        if (top[0] === 'up') return t('trendUp');
        if (top[0] === 'stable') return t('trendStable');
        if (top[0] === 'down') return t('trendDown');
        return t('trendNone');
      }

      function pickMajorityStatus(bucket) {
        if (!bucket) return '';
        const g = bucket.green || 0;
        const y = bucket.yellow || 0;
        const r = bucket.red || 0;
        const max = Math.max(g, y, r);
        if (max === 0) return '';
        if (g === max) return 'green';
        if (y === max) return 'yellow';
        return 'red';
      }

      function labelStatusRu(s) {
        if (s === 'green') return 'Зелёный';
        if (s === 'yellow') return 'Жёлтый';
        if (s === 'red') return 'Красный';
        return '—';
      }

      function labelStatusEn(s) {
        if (s === 'green') return 'Green';
        if (s === 'yellow') return 'Yellow';
        if (s === 'red') return 'Red';
        return '—';
      }

      function labelTrendRu(tr) {
        if (tr === 'up') return '↗ Улучшается';
        if (tr === 'stable') return '→ Стабильно';
        if (tr === 'down') return '↘ Ухудшается';
        if (typeof tr === 'string' && tr.includes('↗')) return '↗ Улучшается';
        if (typeof tr === 'string' && tr.includes('→')) return '→ Стабильно';
        if (typeof tr === 'string' && tr.includes('↘')) return '↘ Ухудшается';
        return '—';
      }

      function labelTrendEn(tr) {
        if (tr === 'up') return '↗ Improving';
        if (tr === 'stable') return '→ Stable';
        if (tr === 'down') return '↘ Worsening';
        if (typeof tr === 'string' && tr.includes('↗')) return '↗ Improving';
        if (typeof tr === 'string' && tr.includes('→')) return '→ Stable';
        if (typeof tr === 'string' && tr.includes('↘')) return '↘ Worsening';
        return '—';
      }

      function trendLabelToCode(v) {
        if (!v) return '';
        if (v === 'up' || v === 'stable' || v === 'down') return v;
        const s = String(v);
        if (s.includes('↗')) return 'up';
        if (s.includes('→')) return 'stable';
        if (s.includes('↘')) return 'down';
        return '';
      }

      function escapeAttr(s) {
        return String(s == null ? '' : s)
          .replaceAll('&', '&amp;')
          .replaceAll('"', '&quot;')
          .replaceAll('<', '&lt;')
          .replaceAll('>', '&gt;');
      }

      function exportMultiCsv() {
        const latest = pickLatestDatePerTeam();
        const teams = Array.from(latest.keys()).sort((a, b) => a.localeCompare(b));
        const header = ['team','date','indicator','status','trend','green','yellow','red','responses'];
        const rows = [header];

        for (const team of teams) {
          const date = latest.get(team);
          for (const ind of indicators) {
            const b = getBucket(team, date, ind.id);
            const status = worstStatus(b);
            const trend = b ? worstTrendLabel(b.trendCounts) : '';
            rows.push([
              team,
              date || '',
              indTitle(ind),
              status,
              trend,
              String(b ? b.green : 0),
              String(b ? b.yellow : 0),
              String(b ? b.red : 0),
              String(b ? b.responses : 0)
            ]);
          }
        }
        const csv = rows.map((r) => r.map(escapeCsvCell).join(',')).join('\n');
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `team-health-check_multi_summary_${todayISO()}.csv`;
        a.className = 'sr';
        a.textContent = 'download';
        document.body.appendChild(a);
        a.click();
        a.remove();
        window.setTimeout(() => URL.revokeObjectURL(url), 0);
      }

      // ===== DOM ELEMENTS =====
      const setupScreen = document.getElementById('setupScreen');
      const cardScreen = document.getElementById('cardScreen');
      const resultsScreen = document.getElementById('resultsScreen');
      const compareScreen = document.getElementById('compareScreen');
      const teamNameEl = document.getElementById('teamName');
      const checkDateEl = document.getElementById('checkDate');
      const facilitatorEl = document.getElementById('facilitator');
      const btnStart = document.getElementById('btnStart');
      const participantChips = document.getElementById('participantChips');
      const btnPrev = document.getElementById('btnPrev');
      const btnNext = document.getElementById('btnNext');
      const progressStrip = document.getElementById('progressStrip');
      const indicatorCard = document.getElementById('indicatorCard');
      const overallNotesEl = document.getElementById('overallNotes');
      const btnBackReview = document.getElementById('btnBackReview');
      const btnResetSession = document.getElementById('btnResetSession');
      const btnExportCsv = document.getElementById('btnExportCsv');
      const multiFiles = document.getElementById('multiFiles');
      const multiDrop = document.getElementById('multiDrop');
      const compareActions = document.getElementById('compareActions');
      const compareTableWrap = document.getElementById('compareTableWrap');
      const compareHead = document.getElementById('compareHead');
      const compareBody = document.getElementById('compareBody');
      const btnClearCompare = document.getElementById('btnClearCompare');
      const btnExportCompare = document.getElementById('btnExportCompare');
      const modeSession = document.getElementById('modeSession');
      const modeCompare = document.getElementById('modeCompare');
      const langRuBtn = document.getElementById('langRu');
      const langEnBtn = document.getElementById('langEn');
      const autosaveStatusEl = document.getElementById('autosaveStatus');

      let lastSessionScreen = 'setup';

      // ===== SCREEN MANAGEMENT =====
      function showScreen(name) {
        currentScreen = name;
        [setupScreen, cardScreen, resultsScreen, compareScreen].forEach(s => s.classList.remove('active'));
        const screenMap = { setup: setupScreen, card: cardScreen, results: resultsScreen, compare: compareScreen };
        if (screenMap[name]) screenMap[name].classList.add('active');
        if (modeSession) modeSession.setAttribute('aria-pressed', name !== 'compare' ? 'true' : 'false');
        if (modeCompare) modeCompare.setAttribute('aria-pressed', name === 'compare' ? 'true' : 'false');
      }

      // ===== AUTOSAVE INDICATOR =====
      let autosaveFadeTimer = null;
      function showAutosaveStatus(text) {
        if (!autosaveStatusEl) return;
        autosaveStatusEl.textContent = text;
        autosaveStatusEl.style.opacity = '1';
        if (autosaveFadeTimer) clearTimeout(autosaveFadeTimer);
        autosaveFadeTimer = setTimeout(() => { autosaveStatusEl.style.opacity = '0'; }, 2000);
      }

      // Enhance scheduleAutosave with indicator
      scheduleAutosave = function() {
        if (autosaveTimer) window.clearTimeout(autosaveTimer);
        autosaveTimer = window.setTimeout(() => {
          showAutosaveStatus(t('autosaveSaving'));
          try {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(serialize()));
            const now = new Date();
            const timeStr = `${pad2(now.getHours())}:${pad2(now.getMinutes())}:${pad2(now.getSeconds())}`;
            const savedAtMsg = t('autosaveSavedAt');
            showAutosaveStatus(typeof savedAtMsg === 'function' ? savedAtMsg(timeStr) : `Saved at ${timeStr}`);
          } catch(_) {
            showAutosaveStatus(t('autosaveFailed'));
          }
        }, 250);
      };

      // ===== SETUP SCREEN =====
      function renderSetup() {
        if (!participantChips) return;
        participantChips.innerHTML = '';
        state.columns.forEach((col, i) => {
          const chip = document.createElement('div');
          chip.className = 'chip';
          chip.innerHTML = `<input type="text" value="${escapeAttr(col.name)}" placeholder="${t('participantName')}" data-col-id="${col.id}" aria-label="${t('participantNameLabel')}" /><button type="button" class="chip-remove" data-remove-col="${col.id}" aria-label="${t('removeParticipant')}">&times;</button>`;
          participantChips.appendChild(chip);
        });
        const addBtn = document.createElement('button');
        addBtn.type = 'button';
        addBtn.className = 'chip-add';
        addBtn.textContent = `+ ${t('setup.addParticipant')}`;
        addBtn.addEventListener('click', addParticipant);
        participantChips.appendChild(addBtn);
        updateStartButton();
      }

      function addParticipant() {
        const col = blankColumn();
        state.columns.push(col);
        ensureStateShape();
        renderSetup();
        const newInput = participantChips.querySelector(`input[data-col-id="${col.id}"]`);
        if (newInput) newInput.focus();
        scheduleAutosave();
      }

      function removeParticipant(colId) {
        if (state.columns.length <= 1) return;
        state.columns = state.columns.filter(c => c.id !== colId);
        for (const ind of indicators) {
          if (state.data[ind.id]) delete state.data[ind.id][colId];
        }
        ensureStateShape();
        renderSetup();
        scheduleAutosave();
      }

      function updateStartButton() {
        if (!btnStart) return;
        const hasParticipant = state.columns.some(c => c.name.trim() !== '');
        btnStart.disabled = !hasParticipant;
      }

      function startSession() {
        currentCardIndex = 0;
        showScreen('card');
        renderCard(currentCardIndex);
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }

      // ===== CARD FLOW SCREEN =====
      function isCardComplete(index) {
        const ind = indicators[index];
        if (!ind) return false;
        return state.columns.every(col => {
          const cell = state.data[ind.id] && state.data[ind.id][col.id];
          return cell && cell.status && cell.trend;
        });
      }

      function renderCard(index) {
        if (!progressStrip || !indicatorCard) return;
        const ind = indicators[index];
        if (!ind) return;

        // Progress strip
        let stripHTML = '';
        indicators.forEach((_, i) => {
          const cls = i === index ? 'current' : isCardComplete(i) ? 'completed' : '';
          stripHTML += `<button type="button" class="progress-dot ${cls}" data-card-index="${i}" aria-label="${indShort(indicators[i])}" title="${indTitle(indicators[i])}"></button>`;
        });
        stripHTML += `<span class="progress-counter">${index + 1} / ${indicators.length}</span>`;
        progressStrip.innerHTML = stripHTML;

        // Indicator card
        let cardHTML = `
          <h2 class="indicator-title">${escapeAttr(indTitle(ind))}</h2>
          <div class="indicator-descriptions">
            <div class="desc-col desc-ok">
              <div class="desc-label label-ok">${t('card.healthy')}</div>
              <div class="desc-text">${escapeAttr(indAwesome(ind))}</div>
            </div>
            <div class="desc-col desc-bad">
              <div class="desc-label label-bad">${t('card.unhealthy')}</div>
              <div class="desc-text">${escapeAttr(indCrappy(ind))}</div>
            </div>
          </div>
          <div class="participant-rows">
        `;

        for (const col of state.columns) {
          const cell = (state.data[ind.id] && state.data[ind.id][col.id]) || { status: '', trend: '', note: '' };
          const hasStatus = !!cell.status;
          const hasTrend = !!cell.trend;

          cardHTML += `
            <div class="participant-row" data-col-id="${col.id}">
              <div class="p-name">${escapeAttr(col.name || t('participant'))}</div>
              <div class="status-buttons${hasStatus ? ' has-selection' : ''}">
                <button type="button" class="status-btn s-ok${cell.status === 'green' ? ' selected' : ''}" data-status="green" data-ind="${ind.id}" data-col="${col.id}" aria-label="${t('green')}"><span class="dot-inner"></span></button>
                <button type="button" class="status-btn s-warn${cell.status === 'yellow' ? ' selected' : ''}" data-status="yellow" data-ind="${ind.id}" data-col="${col.id}" aria-label="${t('yellow')}"><span class="dot-inner"></span></button>
                <button type="button" class="status-btn s-bad${cell.status === 'red' ? ' selected' : ''}" data-status="red" data-ind="${ind.id}" data-col="${col.id}" aria-label="${t('red')}"><span class="dot-inner"></span></button>
              </div>
              <div class="trend-buttons${hasTrend ? ' has-selection' : ''}">
                <button type="button" class="trend-btn${cell.trend === 'up' ? ' selected' : ''}" data-trend="up" data-ind="${ind.id}" data-col="${col.id}" aria-label="${t('trendUp')}">&#x2197;</button>
                <button type="button" class="trend-btn${cell.trend === 'stable' ? ' selected' : ''}" data-trend="stable" data-ind="${ind.id}" data-col="${col.id}" aria-label="${t('trendStable')}">&#x2192;</button>
                <button type="button" class="trend-btn${cell.trend === 'down' ? ' selected' : ''}" data-trend="down" data-ind="${ind.id}" data-col="${col.id}" aria-label="${t('trendDown')}">&#x2198;</button>
              </div>
              <input type="text" class="note-input" data-note-ind="${ind.id}" data-note-col="${col.id}" value="${escapeAttr(cell.note)}" placeholder="${t('card.notePlaceholder')}" aria-label="${t('note')}" />
            </div>
          `;
        }

        cardHTML += '</div>';
        indicatorCard.innerHTML = cardHTML;

        // Nav buttons
        if (btnPrev) {
          btnPrev.textContent = `\u2190 ${t('card.prev')}`;
          btnPrev.style.visibility = index === 0 ? 'hidden' : 'visible';
        }
        if (btnNext) {
          const isLast = index >= indicators.length - 1;
          btnNext.textContent = isLast ? t('card.finish') : `${t('card.next')} \u2192`;
          btnNext.classList.toggle('ready', isCardComplete(index));
        }
      }

      function goToCard(index) {
        if (index < 0 || index >= indicators.length) return;
        currentCardIndex = index;
        renderCard(index);
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }

      function nextCard() {
        if (currentCardIndex >= indicators.length - 1) {
          showScreen('results');
          renderResults();
          window.scrollTo({ top: 0, behavior: 'smooth' });
          return;
        }
        goToCard(currentCardIndex + 1);
      }

      function prevCard() {
        if (currentCardIndex <= 0) return;
        goToCard(currentCardIndex - 1);
      }

      // ===== RESULTS SCREEN =====
      function renderResults() {
        const body = document.getElementById('resultsBody');
        if (!body) return;
        body.innerHTML = '';

        indicators.forEach((ind, i) => {
          let dotsHTML = '';
          let trendsHTML = '';
          state.columns.forEach(col => {
            const cell = (state.data[ind.id] && state.data[ind.id][col.id]) || {};
            const statusCls = cell.status === 'green' ? 'r-ok' : cell.status === 'yellow' ? 'r-warn' : cell.status === 'red' ? 'r-bad' : 'r-empty';
            const trendChar = cell.trend === 'up' ? '\u2197' : cell.trend === 'stable' ? '\u2192' : cell.trend === 'down' ? '\u2198' : '\u2014';
            const tip = `${escapeAttr(col.name || t('participant'))}${cell.note ? ': ' + escapeAttr(cell.note) : ''}`;
            dotsHTML += `<span class="result-dot ${statusCls}" title="${tip}"></span>`;
            trendsHTML += `<span title="${escapeAttr(col.name || t('participant'))}">${trendChar}</span>`;
          });

          const row = document.createElement('div');
          row.className = 'result-row';
          row.dataset.reviewIndex = i;
          row.innerHTML = `<div class="result-indicator">${escapeAttr(indTitle(ind))}</div><div class="result-dots">${dotsHTML}</div><div class="result-trends">${trendsHTML}</div>`;
          body.appendChild(row);
        });

        if (btnBackReview) btnBackReview.textContent = `\u2190 ${t('results.backToReview')}`;
        if (btnResetSession) btnResetSession.textContent = t('reset');
        if (btnExportCsv) btnExportCsv.textContent = t('results.exportCsv');
        if (overallNotesEl) overallNotesEl.value = state.global.overallNotes || '';
      }

      // ===== COMPARE SCREEN =====
      function renderMultiSummary() {
        if (!compareBody || !compareHead) return;
        compareHead.innerHTML = '';
        compareBody.innerHTML = '';

        const latest = pickLatestDatePerTeam();
        const teams = Array.from(latest.keys()).sort();

        const hasData = !!teams.length;
        if (compareActions) compareActions.style.display = hasData ? '' : 'none';
        if (compareTableWrap) compareTableWrap.style.display = hasData ? '' : 'none';
        if (multiDrop) multiDrop.style.display = hasData ? 'none' : '';
        if (!hasData) return;

        // Header row
        const hr = document.createElement('tr');
        hr.innerHTML = '<th></th>';
        teams.forEach(team => {
          const date = latest.get(team);
          hr.innerHTML += `<th>${escapeAttr(team)}<div style="font-weight:400;font-size:12px;color:var(--muted);margin-top:2px;">${escapeAttr(date || '')}</div></th>`;
        });
        compareHead.appendChild(hr);

        // Body rows
        indicators.forEach(ind => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<th>${escapeAttr(indShort(ind))}</th>`;
          teams.forEach(team => {
            const date = latest.get(team);
            const b = getBucket(team, date, ind.id);
            const status = worstStatus(b);
            const trendLabel = b ? worstTrendLabel(b.trendCounts) : '\u2014';
            const cls = status === 'green' ? 'ok' : status === 'yellow' ? 'warn' : status === 'red' ? 'bad' : '';
            const trendChar = trendLabel.includes('\u2197') ? '\u2197' : trendLabel.includes('\u2198') ? '\u2198' : trendLabel.includes('\u2192') ? '\u2192' : '\u2014';

            // Build tooltip
            let tip = '';
            if (b) {
              const votes = Array.isArray(b.votes) ? b.votes : [];
              if (votes.length) {
                tip = votes.map(v => {
                  const who = (v.participantName || v.participantId || t('participant')).trim();
                  const labelS = lang === 'en' ? labelStatusEn : labelStatusRu;
                  const labelT = lang === 'en' ? labelTrendEn : labelTrendRu;
                  return `${who}: ${labelS(v.status)}, ${labelT(v.trend)}`;
                }).join('\n');
              } else {
                tip = `${t('green')}: ${b.green || 0}\n${t('yellow')}: ${b.yellow || 0}\n${t('red')}: ${b.red || 0}`;
              }
            }

            tr.innerHTML += `<td><div class="sumCell" title="${escapeAttr(tip)}"><span class="sumDot ${cls}"></span><span class="sumTrend">${trendChar}</span></div></td>`;
          });
          compareBody.appendChild(tr);
        });
      }

      async function handleMultiFiles(files) {
        const list = Array.from(files || []);
        if (!list.length) return;
        for (const f of list) {
          const text = await f.text();
          const rows = parseCsv(text);
          const objects = rowsToObjects(rows);
          const header = rows && rows[0] ? rows[0].map(normalizeHeader) : [];
          if (header.includes('participant_id') && header.includes('indicator') && header.includes('status')) {
            addParticipantExport(objects);
          } else if (header.includes('green') && header.includes('yellow') && header.includes('red') && header.includes('indicator')) {
            addSummaryExport(objects);
          }
        }
        renderMultiSummary();
      }

      function clearMulti() {
        multiAgg = new Map();
        if (multiFiles) multiFiles.value = '';
        renderMultiSummary();
      }

      // ===== LANGUAGE =====
      function applyLanguage() {
        document.documentElement.lang = lang;
        // Header
        const appTitle = document.getElementById('appTitle');
        if (appTitle) appTitle.textContent = 'Team Health Check';
        if (modeSession) modeSession.textContent = t('mode.session');
        if (modeCompare) modeCompare.textContent = t('mode.compare');
        if (langRuBtn) langRuBtn.setAttribute('aria-pressed', lang === 'ru' ? 'true' : 'false');
        if (langEnBtn) langEnBtn.setAttribute('aria-pressed', lang === 'en' ? 'true' : 'false');

        // Setup screen
        const setupTitle = document.getElementById('setupTitle');
        if (setupTitle) setupTitle.textContent = t('setup.title');
        const labelTeam = document.getElementById('labelTeam');
        if (labelTeam) labelTeam.textContent = t('teamLabel');
        const labelDate = document.getElementById('labelDate');
        if (labelDate) labelDate.textContent = t('dateLabel');
        const labelFac = document.getElementById('labelFac');
        if (labelFac) labelFac.textContent = t('facilitatorLabel');
        const participantsTitle = document.getElementById('participantsTitle');
        if (participantsTitle) participantsTitle.textContent = t('participantsHeading');
        if (btnStart) btnStart.textContent = t('setup.startSession');

        // Results
        const resultsTitle = document.getElementById('resultsTitle');
        if (resultsTitle) resultsTitle.textContent = t('results.title');
        const labelOverallNotes = document.getElementById('labelOverallNotes');
        if (labelOverallNotes) labelOverallNotes.textContent = t('results.overallNotes');
        if (overallNotesEl) overallNotesEl.placeholder = t('results.overallNotesPlaceholder');

        // Compare
        const dropTitle = document.getElementById('dropTitle');
        if (dropTitle) dropTitle.textContent = t('dropTitle');
        const dropHint = document.getElementById('dropHint');
        if (dropHint) dropHint.textContent = t('dropHint');
        if (btnClearCompare) btnClearCompare.textContent = t('clear');
        if (btnExportCompare) btnExportCompare.textContent = t('exportSummary');

        // Footer
        const footerLeft = document.getElementById('footerLeft');
        if (footerLeft) footerLeft.firstChild.nodeValue = `${t('footerLeft')} `;
        const telegramCredit = document.getElementById('telegramCredit');
        if (telegramCredit) telegramCredit.innerHTML = t('telegramCreditHtml');
        const otherProjectsLink = document.getElementById('otherProjectsLink');
        if (otherProjectsLink) otherProjectsLink.textContent = t('otherProjects');

        // Re-render current screen
        if (currentScreen === 'setup') renderSetup();
        if (currentScreen === 'card') renderCard(currentCardIndex);
        if (currentScreen === 'results') renderResults();
        if (currentScreen === 'compare') renderMultiSummary();
      }

      // ===== EVENT BINDINGS =====

      // Setup: participant chip events (delegation)
      if (participantChips) {
        participantChips.addEventListener('input', (e) => {
          if (e.target.matches('input[data-col-id]')) {
            const colId = e.target.dataset.colId;
            const col = state.columns.find(c => c.id === colId);
            if (col) col.name = e.target.value;
            updateStartButton();
            scheduleAutosave();
          }
        });
        participantChips.addEventListener('click', (e) => {
          const btn = e.target.closest('[data-remove-col]');
          if (btn) removeParticipant(btn.dataset.removeCol);
        });
      }
      if (btnStart) btnStart.addEventListener('click', startSession);

      // Metadata fields -> state
      if (teamNameEl) teamNameEl.addEventListener('input', () => { state.global.team = teamNameEl.value; scheduleAutosave(); });
      if (checkDateEl) checkDateEl.addEventListener('change', () => { state.global.date = checkDateEl.value; scheduleAutosave(); });
      if (facilitatorEl) facilitatorEl.addEventListener('input', () => { state.global.facilitator = facilitatorEl.value; scheduleAutosave(); });

      // Card flow events (delegation on cardScreen)
      if (cardScreen) {
        cardScreen.addEventListener('click', (e) => {
          // Status buttons
          const statusBtn = e.target.closest('[data-status]');
          if (statusBtn) {
            const { status, ind, col } = statusBtn.dataset;
            if (state.data[ind] && state.data[ind][col]) {
              state.data[ind][col].status = status;
              renderCard(currentCardIndex);
              scheduleAutosave();
            }
            return;
          }
          // Trend buttons
          const trendBtn = e.target.closest('[data-trend]');
          if (trendBtn) {
            const { trend, ind, col } = trendBtn.dataset;
            if (state.data[ind] && state.data[ind][col]) {
              state.data[ind][col].trend = trend;
              renderCard(currentCardIndex);
              scheduleAutosave();
            }
            return;
          }
          // Progress dots
          const dot = e.target.closest('[data-card-index]');
          if (dot) {
            goToCard(parseInt(dot.dataset.cardIndex, 10));
            return;
          }
        });
        // Note input (delegation)
        cardScreen.addEventListener('input', (e) => {
          if (e.target.matches('[data-note-ind]')) {
            const ind = e.target.dataset.noteInd;
            const col = e.target.dataset.noteCol;
            if (state.data[ind] && state.data[ind][col]) {
              state.data[ind][col].note = e.target.value;
              scheduleAutosave();
            }
          }
        });
      }

      if (btnPrev) btnPrev.addEventListener('click', prevCard);
      if (btnNext) btnNext.addEventListener('click', nextCard);

      // Keyboard shortcuts
      window.addEventListener('keydown', (e) => {
        if (currentScreen !== 'card') return;
        const tag = (e.target.tagName || '').toLowerCase();
        if (tag === 'input' || tag === 'textarea' || tag === 'select') return;
        if (e.key === 'ArrowRight') { e.preventDefault(); nextCard(); }
        if (e.key === 'ArrowLeft') { e.preventDefault(); prevCard(); }
      });

      // Results events
      if (document.getElementById('resultsBody')) {
        document.getElementById('resultsBody').addEventListener('click', (e) => {
          const row = e.target.closest('[data-review-index]');
          if (row) {
            goToCard(parseInt(row.dataset.reviewIndex, 10));
            showScreen('card');
          }
        });
      }
      if (btnBackReview) btnBackReview.addEventListener('click', () => { goToCard(0); showScreen('card'); });
      if (btnResetSession) btnResetSession.addEventListener('click', () => {
        if (!window.confirm(t('resetConfirm'))) return;
        try { localStorage.removeItem(STORAGE_KEY); } catch(_) {}
        state = { global: { team: '', date: todayISO(), facilitator: '', overallNotes: '' }, columns: [blankColumn()], data: {} };
        ensureStateShape();
        showScreen('setup');
        renderSetup();
        if (teamNameEl) teamNameEl.value = '';
        if (checkDateEl) checkDateEl.value = state.global.date;
        if (facilitatorEl) facilitatorEl.value = '';
      });
      if (btnExportCsv) btnExportCsv.addEventListener('click', exportCsv);
      if (overallNotesEl) overallNotesEl.addEventListener('input', () => { state.global.overallNotes = overallNotesEl.value; scheduleAutosave(); });

      // Compare events
      if (multiFiles) multiFiles.addEventListener('change', (e) => { if (e.target.files) handleMultiFiles(e.target.files); });
      if (multiDrop) {
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(type => multiDrop.addEventListener(type, e => { e.preventDefault(); e.stopPropagation(); }));
        multiDrop.addEventListener('dragenter', () => multiDrop.classList.add('dragover'));
        multiDrop.addEventListener('dragover', () => multiDrop.classList.add('dragover'));
        multiDrop.addEventListener('dragleave', () => multiDrop.classList.remove('dragover'));
        multiDrop.addEventListener('drop', (e) => { multiDrop.classList.remove('dragover'); if (e.dataTransfer && e.dataTransfer.files) handleMultiFiles(e.dataTransfer.files); });
      }
      if (btnClearCompare) btnClearCompare.addEventListener('click', clearMulti);
      if (btnExportCompare) btnExportCompare.addEventListener('click', exportMultiCsv);

      // Mode toggle
      if (modeSession) modeSession.addEventListener('click', () => {
        if (currentScreen === 'compare') {
          showScreen(lastSessionScreen || 'setup');
        }
      });
      if (modeCompare) modeCompare.addEventListener('click', () => {
        if (currentScreen !== 'compare') {
          lastSessionScreen = currentScreen;
          showScreen('compare');
        }
      });

      // Language toggle
      if (langRuBtn) langRuBtn.addEventListener('click', () => setLang('ru'));
      if (langEnBtn) langEnBtn.addEventListener('click', () => setLang('en'));

      // Patch setLang to call applyLanguage
      const _origSetLang = setLang;
      setLang = function(next) {
        _origSetLang(next);
        applyLanguage();
      };

      // ===== INITIALIZATION =====
      migrateLegacyIfNeeded();
      migrateMatrixToParticipantsIfNeeded();
      migrateV1toV2IfNeeded();

      const savedRaw = (() => { try { return localStorage.getItem(STORAGE_KEY); } catch(_) { return null; } })();
      if (savedRaw) {
        try {
          const saved = JSON.parse(savedRaw);
          const hasData = saved && saved.columns && saved.columns.some(c => c.name);
          if (hasData && window.confirm(t('setup.resumePrompt'))) {
            applyState(saved);
          } else if (!hasData) {
            applyState(saved);
          } else {
            state = { global: { team: '', date: todayISO(), facilitator: '', overallNotes: '' }, columns: [blankColumn()], data: {} };
            ensureStateShape();
          }
        } catch(_) {
          state = { global: { team: '', date: todayISO(), facilitator: '', overallNotes: '' }, columns: [blankColumn()], data: {} };
          ensureStateShape();
        }
      } else {
        ensureStateShape();
      }

      // Apply to UI
      if (teamNameEl) teamNameEl.value = state.global.team || '';
      if (checkDateEl) checkDateEl.value = state.global.date || todayISO();
      if (facilitatorEl) facilitatorEl.value = state.global.facilitator || '';
      renderSetup();
      applyLanguage();
      showScreen('setup');

    })();
  </script>
</body>
</html>
